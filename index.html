<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetControl Pro V3.0 - Sistema Avançado de Gestão de Frota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#FF6B35',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        info: '#3B82F6'
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-700 dark:text-gray-300 font-medium">Processando...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="relative">
                        <i class="fas fa-truck text-primary text-3xl mr-3 animate-pulse-slow"></i>
                        <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-success rounded-full border-2 border-white dark:border-gray-800 animate-bounce-slow" title="Sistema Online"></div>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">FleetControl Pro</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Sistema Avançado de Gestão de Frota v3.0</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="hidden md:block text-right">
                        <p class="text-sm font-medium text-gray-900 dark:text-white" id="currentDateTime"></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Última atualização</p>
                    </div>
                    
                    <!-- Enhanced Quick Stats -->
                    <div class="hidden lg:flex items-center space-x-4 px-4 py-2 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="text-center">
                            <span class="text-xs text-gray-500 dark:text-gray-400">Veículos</span>
                            <div class="text-sm font-bold text-primary" id="headerVehicleCount">0</div>
                        </div>
                        <div class="h-6 w-px bg-gray-300 dark:bg-gray-500"></div>
                        <div class="text-center">
                            <span class="text-xs text-gray-500 dark:text-gray-400">Alertas</span>
                            <div class="text-sm font-bold text-warning" id="headerAlertCount">0</div>
                        </div>
                        <div class="h-6 w-px bg-gray-300 dark:bg-gray-500"></div>
                        <div class="text-center">
                            <span class="text-xs text-gray-500 dark:text-gray-400">Taxa OK</span>
                            <div class="text-sm font-bold text-success" id="headerComplianceRate">100%</div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Notifications -->
                    <div class="relative">
                        <button id="alertBtn" onclick="showNotificationsPanel()" class="relative p-3 text-gray-600 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-all duration-200 group">
                            <i class="fas fa-bell text-xl group-hover:animate-pulse"></i>
                            <span id="alertBadge" class="absolute -top-1 -right-1 bg-danger text-white text-xs rounded-full h-6 w-6 flex items-center justify-center hidden animate-bounce">0</span>
                        </button>
                        
                        <!-- Enhanced Notifications Panel -->
                        <div id="notificationsPanel" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-50 animate-slide-up">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-primary/10 to-secondary/10">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                        <i class="fas fa-bell text-primary mr-2"></i>Notificações
                                    </h3>
                                    <span class="text-xs bg-primary/20 text-primary px-2 py-1 rounded-full" id="notificationCount">0</span>
                                </div>
                            </div>
                            <div class="max-h-96 overflow-y-auto custom-scrollbar">
                                <div id="notificationsList" class="p-4 space-y-3">
                                    <!-- Notifications will be populated here -->
                                </div>
                            </div>
                            <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
                                <div class="flex justify-between">
                                    <button onclick="markAllAsRead()" class="text-sm text-primary hover:text-primary/80 transition-colors">Marcar todas como lidas</button>
                                    <button onclick="clearAllNotifications()" class="text-sm text-gray-500 hover:text-red-500 transition-colors">Limpar tudo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Settings -->
                    <button onclick="showSettingsModal()" class="p-3 text-gray-600 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-all duration-200 group" title="Configurações">
                        <i class="fas fa-cog text-xl group-hover:rotate-90 transition-transform duration-300"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Enhanced Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 sticky top-16 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div class="flex space-x-8 overflow-x-auto">
                    <button onclick="showTab('dashboard')" class="nav-btn active-tab py-4 px-1 border-b-2 border-primary text-primary font-medium whitespace-nowrap transition-all duration-200 hover:bg-primary/5">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </button>
                    <button onclick="showTab('vehicles')" class="nav-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap transition-all duration-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-truck mr-2"></i>Veículos
                    </button>
                    <button onclick="showTab('drivers')" class="nav-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap transition-all duration-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-users mr-2"></i>Motoristas
                    </button>
                    <button onclick="showTab('speed-tracking')" class="nav-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap transition-all duration-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-tachometer-alt mr-2"></i>Monitoramento
                    </button>
                    <button onclick="showTab('reports')" class="nav-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap transition-all duration-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-chart-bar mr-2"></i>Relatórios
                    </button>
                    <button onclick="showTab('backup')" class="nav-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap transition-all duration-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <i class="fas fa-database mr-2"></i>Backup & Dados
                    </button>
                </div>
                
                <!-- Enhanced Data Management Actions -->
                <div class="flex items-center space-x-2">
                    <div class="flex items-center space-x-2 px-3 py-1 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div id="saveStatus" class="w-3 h-3 rounded-full bg-green-500 animate-pulse" title="Sistema ativo"></div>
                        <span class="text-xs text-gray-500 dark:text-gray-400" id="saveStatusText">Dados salvos</span>
                    </div>
                    <button onclick="forceSave()" class="p-2 text-gray-600 dark:text-gray-300 hover:text-success hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-all duration-200 group" title="Salvar Agora">
                        <i class="fas fa-save text-sm group-hover:scale-110 transition-transform"></i>
                    </button>
                    <button onclick="showImportModal()" class="p-2 text-gray-600 dark:text-gray-300 hover:text-info hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-all duration-200 group" title="Importar Dados">
                        <i class="fas fa-upload text-sm group-hover:scale-110 transition-transform"></i>
                    </button>
                    <button onclick="exportAllData()" class="p-2 text-gray-600 dark:text-gray-300 hover:text-primary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-all duration-200 group" title="Exportar Tudo">
                        <i class="fas fa-download text-sm group-hover:scale-110 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Enhanced Toast Notification -->
    <div id="toast" class="fixed top-20 right-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 border-l-4 rounded-lg shadow-xl p-4 max-w-sm transform transition-all duration-300 animate-slide-up">
            <div class="flex items-center">
                <i id="toastIcon" class="text-xl mr-3"></i>
                <div class="flex-1">
                    <p id="toastTitle" class="font-medium text-gray-900 dark:text-white"></p>
                    <p id="toastMessage" class="text-sm text-gray-600 dark:text-gray-300"></p>
                </div>
                <button onclick="hideToast()" class="ml-auto text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="toastProgress" class="absolute bottom-0 left-0 h-1 bg-primary rounded-b-lg transition-all duration-5000"></div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Enhanced Dashboard Tab -->
        <div id="dashboard" class="tab-content animate-fade-in">
            <!-- Enhanced Quick Actions -->
            <div class="mb-6">
                <div class="flex flex-wrap gap-3">
                    <button onclick="showSpeedEntryModal()" class="bg-gradient-to-r from-primary to-primary/80 text-white px-4 py-2 rounded-lg hover:from-primary/90 hover:to-primary/70 transition-all duration-200 flex items-center shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>Registrar Velocidade
                    </button>
                    <button onclick="showAddVehicleModal()" class="bg-gradient-to-r from-success to-success/80 text-white px-4 py-2 rounded-lg hover:from-success/90 hover:to-success/70 transition-all duration-200 flex items-center shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fas fa-truck mr-2"></i>Novo Veículo
                    </button>
                    <button onclick="showAddDriverModal()" class="bg-gradient-to-r from-info to-info/80 text-white px-4 py-2 rounded-lg hover:from-info/90 hover:to-info/70 transition-all duration-200 flex items-center shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fas fa-user-plus mr-2"></i>Novo Motorista
                    </button>
                    <button onclick="generateQuickReport()" class="bg-gradient-to-r from-secondary to-secondary/80 text-white px-4 py-2 rounded-lg hover:from-secondary/90 hover:to-secondary/70 transition-all duration-200 flex items-center shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fas fa-chart-line mr-2"></i>Relatório Rápido
                    </button>
                    <button onclick="exportToExcel()" class="bg-gradient-to-r from-warning to-warning/80 text-white px-4 py-2 rounded-lg hover:from-warning/90 hover:to-warning/70 transition-all duration-200 flex items-center shadow-md hover:shadow-lg transform hover:scale-105">
                        <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                    </button>
                </div>
            </div>

            <!-- Enhanced Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 border-l-4 border-primary hover:shadow-xl transition-all duration-300 transform hover:scale-105 animate-fade-in">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 p-3 bg-gradient-to-br from-primary/20 to-primary/10 rounded-lg">
                            <i class="fas fa-truck text-primary text-3xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total de Veículos</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white" id="totalVehicles">0</p>
                            <div class="flex items-center mt-2">
                                <span class="text-xs text-success flex items-center">
                                    <i class="fas fa-arrow-up mr-1"></i>Frota ativa
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 border-l-4 border-success hover:shadow-xl transition-all duration-300 transform hover:scale-105 animate-fade-in">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 p-3 bg-gradient-to-br from-success/20 to-success/10 rounded-lg">
                            <i class="fas fa-user-check text-success text-3xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Motoristas Ativos</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white" id="activeDrivers">0</p>
                            <div class="flex items-center mt-2">
                                <span class="text-xs text-success flex items-center">
                                    <i class="fas fa-check-circle mr-1"></i>Em serviço
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 border-l-4 border-warning hover:shadow-xl transition-all duration-300 transform hover:scale-105 animate-fade-in">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 p-3 bg-gradient-to-br from-warning/20 to-warning/10 rounded-lg">
                            <i class="fas fa-exclamation-triangle text-warning text-3xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">A Vencer</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white" id="expiringSoon">0</p>
                            <div class="flex items-center mt-2">
                                <span class="text-xs text-warning flex items-center">
                                    <i class="fas fa-clock mr-1"></i>Próximos 30 dias
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 border-l-4 border-danger hover:shadow-xl transition-all duration-300 transform hover:scale-105 animate-fade-in">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 p-3 bg-gradient-to-br from-danger/20 to-danger/10 rounded-lg">
                            <i class="fas fa-times-circle text-danger text-3xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Vencidos</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white" id="expired">0</p>
                            <div class="flex items-center mt-2">
                                <span class="text-xs text-danger flex items-center">
                                    <i class="fas fa-exclamation-circle mr-1"></i>Requer atenção
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Performance Metrics -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-chart-line text-primary mr-2"></i>Performance Geral
                        </h4>
                        <span class="text-xs bg-primary/20 text-primary px-2 py-1 rounded-full" id="performanceScore">0%</span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Taxa de Conformidade</span>
                            <span class="text-sm font-medium text-green-600" id="complianceRate">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div id="complianceBar" class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Documentos em Dia</span>
                            <span class="text-sm font-medium text-blue-600" id="docsUpToDate">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div id="docsBar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-tachometer-alt text-warning mr-2"></i>Velocidade Média
                        </h4>
                        <span class="text-xs bg-warning/20 text-warning px-2 py-1 rounded-full" id="avgSpeedToday">0 km/h</span>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-900 dark:text-white mb-2" id="fleetAvgSpeed">0</div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">km/h média da frota</p>
                        <div class="mt-4 flex justify-center">
                            <div class="w-24 h-24 rounded-full border-4 border-gray-200 dark:border-gray-700 relative">
                                <div id="speedGauge" class="absolute inset-0 rounded-full border-4 border-transparent transition-all duration-1000" style="background: conic-gradient(from 0deg, #10B981 0%, #F59E0B 70%, #EF4444 90%)"></div>
                                <div class="absolute inset-2 bg-white dark:bg-gray-800 rounded-full flex items-center justify-center">
                                    <span class="text-xs font-bold text-gray-700 dark:text-gray-300" id="speedPercentage">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <i class="fas fa-calendar-alt text-info mr-2"></i>Hoje
                        </h4>
                        <span class="text-xs bg-info/20 text-info px-2 py-1 rounded-full" id="todayDate"></span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Registros</span>
                            <span class="text-lg font-bold text-gray-900 dark:text-white" id="todayRecords">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Infrações</span>
                            <span class="text-lg font-bold text-red-600" id="todayViolations">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600 dark:text-gray-400">Veículos Ativos</span>
                            <span class="text-lg font-bold text-green-600" id="todayActiveVehicles">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-chart-pie text-primary mr-2"></i>Status dos Documentos
                            </h3>
                            <div class="flex space-x-2">
                                <button onclick="refreshDocumentsChart()" class="text-gray-400 hover:text-primary transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="toggleChartType('documents')" class="text-gray-400 hover:text-primary transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="documentsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-tachometer-alt text-primary mr-2"></i>Infrações por Período
                            </h3>
                            <div class="flex space-x-2">
                                <select id="violationsChartPeriod" onchange="refreshViolationsChart()" class="text-xs bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-2 py-1">
                                    <option value="7">7 dias</option>
                                    <option value="30">30 dias</option>
                                    <option value="90">90 dias</option>
                                </select>
                                <button onclick="refreshViolationsChart()" class="text-gray-400 hover:text-primary transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="violationsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Recent Activity and Alerts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-warning/10 to-danger/10">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-bell text-warning mr-2 animate-pulse"></i>Alertas Prioritários
                            </h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs bg-warning/20 text-warning px-2 py-1 rounded-full" id="alertsCount">0</span>
                                <button onclick="refreshAlerts()" class="text-gray-400 hover:text-warning transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 max-h-80 overflow-y-auto custom-scrollbar">
                        <div id="alertsList" class="space-y-4">
                            <!-- Alerts will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-info/10 to-primary/10">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-clock text-info mr-2"></i>Atividade Recente
                            </h3>
                            <div class="flex space-x-2">
                                <button onclick="clearRecentActivity()" class="text-xs text-gray-400 hover:text-danger transition-colors px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Limpar</button>
                                <button onclick="refreshRecentActivity()" class="text-gray-400 hover:text-info transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 max-h-80 overflow-y-auto custom-scrollbar">
                        <div id="recentActivity" class="space-y-4">
                            <!-- Recent activity will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Vehicles Tab -->
        <div id="vehicles" class="tab-content hidden animate-fade-in">
            <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-primary/5 to-secondary/5">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-truck text-primary mr-2"></i>Gestão de Veículos
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Controle completo da frota</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <!-- Enhanced Search -->
                            <div class="relative">
                                <input type="text" id="vehicleSearch" placeholder="Buscar veículo..." class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white w-64 focus:ring-2 focus:ring-primary focus:border-primary transition-all" oninput="debouncedVehicleSearch()">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <div id="vehicleSearchLoading" class="absolute right-3 top-3 hidden">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Filters -->
                            <select id="vehicleStatusFilter" onchange="filterVehicles()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Todos os status</option>
                                <option value="Em dia">Em dia</option>
                                <option value="A vencer">A vencer</option>
                                <option value="Vencido">Vencido</option>
                            </select>
                            
                            <select id="vehicleYearFilter" onchange="filterVehicles()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Todos os anos</option>
                            </select>
                            
                            <button onclick="showAddVehicleModal()" class="bg-gradient-to-r from-primary to-primary/80 text-white px-4 py-2 rounded-lg hover:from-primary/90 hover:to-primary/70 transition-all duration-200 flex items-center shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Adicionar Veículo
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Enhanced Vehicle Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-blue-600 dark:text-blue-400 font-medium">Total</p>
                                    <p class="text-2xl font-bold text-blue-700 dark:text-blue-300" id="vehicleStatsTotal">0</p>
                                </div>
                                <div class="p-2 bg-blue-200 dark:bg-blue-800 rounded-lg">
                                    <i class="fas fa-truck text-blue-600 dark:text-blue-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-4 rounded-lg border border-green-200 dark:border-green-800 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-green-600 dark:text-green-400 font-medium">Em dia</p>
                                    <p class="text-2xl font-bold text-green-700 dark:text-green-300" id="vehicleStatsActive">0</p>
                                </div>
                                <div class="p-2 bg-green-200 dark:bg-green-800 rounded-lg">
                                    <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-800 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-yellow-600 dark:text-yellow-400 font-medium">Alertas</p>
                                    <p class="text-2xl font-bold text-yellow-700 dark:text-yellow-300" id="vehicleStatsAlerts">0</p>
                                </div>
                                <div class="p-2 bg-yellow-200 dark:bg-yellow-800 rounded-lg">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 p-4 rounded-lg border border-purple-200 dark:border-purple-800 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">Idade Média</p>
                                    <p class="text-2xl font-bold text-purple-700 dark:text-purple-300" id="vehicleStatsAvgAge">0</p>
                                </div>
                                <div class="p-2 bg-purple-200 dark:bg-purple-800 rounded-lg">
                                    <i class="fas fa-calendar text-purple-600 dark:text-purple-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Table -->
                    <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="sortVehicles('fleetNumber')">
                                        Frota <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="sortVehicles('plate')">
                                        Placa <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="sortVehicles('model')">
                                        Modelo <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Motoristas por Turno</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="sortVehicles('tachographExpiry')">
                                        Tacógrafo <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Vehicle data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Enhanced Pagination -->
                    <div id="vehiclesPagination" class="mt-6 flex items-center justify-between bg-gray-50 dark:bg-gray-700 px-4 py-3 rounded-lg">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button onclick="previousVehiclesPage()" id="vehiclesPrevBtnMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Anterior
                            </button>
                            <button onclick="nextVehiclesPage()" id="vehiclesNextBtnMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Próximo
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">
                                    Mostrando <span class="font-medium" id="vehiclesShowingStart">0</span> a <span class="font-medium" id="vehiclesShowingEnd">0</span> de <span class="font-medium" id="vehiclesTotal">0</span> veículos
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="previousVehiclesPage()" id="vehiclesPrevBtn" class="relative inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-chevron-left mr-1"></i>Anterior
                                </button>
                                <button onclick="nextVehiclesPage()" id="vehiclesNextBtn" class="ml-3 relative inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    Próximo<i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Drivers Tab -->
        <div id="drivers" class="tab-content hidden animate-fade-in">
            <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-info/5 to-success/5">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-users text-info mr-2"></i>Gestão de Motoristas
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Controle de CNH e qualificações</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <!-- Enhanced Search -->
                            <div class="relative">
                                <input type="text" id="driverSearch" placeholder="Buscar motorista..." class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white w-64 focus:ring-2 focus:ring-info focus:border-info transition-all" oninput="debouncedDriverSearch()">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                <div id="driverSearchLoading" class="absolute right-3 top-3 hidden">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-info"></div>
                                </div>
                            </div>
                            
                            <select id="driverCategoryFilter" onchange="filterDrivers()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-info focus:border-info transition-all">
                                <option value="">Todas as categorias</option>
                                <option value="A">A - Motocicleta</option>
                                <option value="B">B - Carro</option>
                                <option value="C">C - Caminhão</option>
                                <option value="D">D - Ônibus</option>
                                <option value="E">E - Carreta</option>
                            </select>
                            
                            <select id="driverStatusFilter" onchange="filterDrivers()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-info focus:border-info transition-all">
                                <option value="">Todos os status</option>
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                                <option value="CNH Vencida">CNH Vencida</option>
                            </select>
                            
                            <button onclick="showAddDriverModal()" class="bg-gradient-to-r from-info to-info/80 text-white px-4 py-2 rounded-lg hover:from-info/90 hover:to-info/70 transition-all duration-200 flex items-center shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Adicionar Motorista
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Enhanced Driver Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-blue-600 dark:text-blue-400 font-medium">Total</p>
                                    <p class="text-2xl font-bold text-blue-700 dark:text-blue-300" id="driverStatsTotal">0</p>
                                </div>
                                <div class="p-2 bg-blue-200 dark:bg-blue-800 rounded-lg">
                                    <i class="fas fa-users text-blue-600 dark:text-blue-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-4 rounded-lg border border-green-200 dark:border-green-800 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-green-600 dark:text-green-400 font-medium">Ativos</p>
                                    <p class="text-2xl font-bold text-green-700 dark:text-green-300" id="driverStatsActive">0</p>
                                </div>
                                <div class="p-2 bg-green-200 dark:bg-green-800 rounded-lg">
                                    <i class="fas fa-user-check text-green-600 dark:text-green-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-800 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-yellow-600 dark:text-yellow-400 font-medium">CNH a vencer</p>
                                    <p class="text-2xl font-bold text-yellow-700 dark:text-yellow-300" id="driverStatsExpiring">0</p>
                                </div>
                                <div class="p-2 bg-yellow-200 dark:bg-yellow-800 rounded-lg">
                                    <i class="fas fa-clock text-yellow-600 dark:text-yellow-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/20 dark:to-red-800/20 p-4 rounded-lg border border-red-200 dark:border-red-800 hover:shadow-md transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-red-600 dark:text-red-400 font-medium">CNH vencida</p>
                                    <p class="text-2xl font-bold text-red-700 dark:text-red-300" id="driverStatsExpired">0</p>
                                </div>
                                <div class="p-2 bg-red-200 dark:bg-red-800 rounded-lg">
                                    <i class="fas fa-times-circle text-red-600 dark:text-red-400 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Table -->
                    <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="sortDrivers('name')">
                                        Nome <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">CNH</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Categoria</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="sortDrivers('licenseExpiry')">
                                        Vencimento CNH <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Veículos Atribuídos</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="driversTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Driver data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Enhanced Pagination -->
                    <div id="driversPagination" class="mt-6 flex items-center justify-between bg-gray-50 dark:bg-gray-700 px-4 py-3 rounded-lg">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button onclick="previousDriversPage()" id="driversPrevBtnMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Anterior
                            </button>
                            <button onclick="nextDriversPage()" id="driversNextBtnMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Próximo
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">
                                    Mostrando <span class="font-medium" id="driversShowingStart">0</span> a <span class="font-medium" id="driversShowingEnd">0</span> de <span class="font-medium" id="driversTotal">0</span> motoristas
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="previousDriversPage()" id="driversPrevBtn" class="relative inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-chevron-left mr-1"></i>Anterior
                                </button>
                                <button onclick="nextDriversPage()" id="driversNextBtn" class="ml-3 relative inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    Próximo<i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Speed Tracking Tab -->
        <div id="speed-tracking" class="tab-content hidden animate-fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Enhanced Speed Entry Form -->
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-plus-circle text-primary mr-2"></i>Registrar Velocidade por Veículo
                    </h3>
                    <form id="speedEntryForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Veículo <span class="text-red-500">*</span></label>
                            <select id="speedVehicleSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required onchange="updateDriverOptions()">
                                <option value="">Selecione um veículo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno <span class="text-red-500">*</span></label>
                            <select id="speedShiftSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required onchange="updateDriverInfo()">
                                <option value="">Selecione o turno</option>
                                <option value="A">Turno A</option>
                                <option value="B">Turno B</option>
                                <option value="C">Turno C</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Motorista</label>
                            <input type="text" id="speedDriverInfo" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white bg-gray-50 dark:bg-gray-600" readonly placeholder="Motorista será exibido após selecionar veículo e turno">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Velocidade (km/h) <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="number" id="speedValue" min="0" max="200" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="Ex: 85" required oninput="updateSpeedIndicator()">
                                <div id="speedIndicatorMain" class="absolute right-3 top-3 w-3 h-3 rounded-full bg-gray-400 transition-all duration-300"></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Limite da Via (km/h) <span class="text-red-500">*</span></label>
                            <select id="speedLimit" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required onchange="updateSpeedIndicator()">
                                <option value="">Selecione o limite</option>
                                <option value="30">30 km/h - Área Escolar</option>
                                <option value="40">40 km/h - Área Comercial</option>
                                <option value="50">50 km/h - Via Urbana</option>
                                <option value="60">60 km/h - Via Arterial</option>
                                <option value="70">70 km/h - Via Expressa</option>
                                <option value="80">80 km/h - Rodovia</option>
                                <option value="90">90 km/h - Rodovia</option>
                                <option value="100">100 km/h - Rodovia</option>
                                <option value="110">110 km/h - Rodovia</option>
                                <option value="120">120 km/h - Rodovia</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data/Hora <span class="text-red-500">*</span></label>
                            <input type="datetime-local" id="speedDateTime" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Localização <span class="text-red-500">*</span></label>
                            <input type="text" id="speedLocation" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="Ex: BR-101, KM 245" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Observações</label>
                            <textarea id="speedObservations" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="Observações adicionais..."></textarea>
                        </div>
                        
                        <!-- Enhanced Speed Preview -->
                        <div id="speedStatusPreview" class="hidden bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Status previsto:</span>
                                <span id="speedStatusText" class="text-sm font-medium"></span>
                            </div>
                            <div class="mt-2">
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div id="speedPreviewBar" class="h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-primary to-primary/80 text-white px-4 py-3 rounded-lg hover:from-primary/90 hover:to-primary/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                            <i class="fas fa-save mr-2"></i>Registrar Velocidade
                        </button>
                    </form>
                </div>

                <!-- Enhanced Speed Status and Alerts -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-tachometer-alt text-primary mr-2"></i>Status Atual da Frota
                            </h3>
                            <div class="flex space-x-2">
                                <button onclick="refreshSpeedStatus()" class="text-gray-400 hover:text-primary transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="toggleSpeedView()" class="text-gray-400 hover:text-primary transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                                    <i class="fas fa-th-list" id="speedViewIcon"></i>
                                </button>
                            </div>
                        </div>
                        <div id="currentSpeedStatus" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Current speed status will be populated here -->
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-exclamation-triangle text-warning mr-2 animate-pulse"></i>Alertas de Velocidade
                            </h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs bg-warning/20 text-warning px-2 py-1 rounded-full animate-bounce" id="speedAlertsCount">0</span>
                                <button onclick="refreshSpeedAlerts()" class="text-gray-400 hover:text-warning transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div id="speedAlerts" class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar">
                            <!-- Speed alerts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Speed History -->
            <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-warning/5 to-danger/5">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-history text-warning mr-2"></i>Histórico de Velocidade
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Registros de velocidade da frota</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <input type="date" id="speedHistoryDate" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white text-sm focus:ring-2 focus:ring-warning focus:border-warning transition-all" onchange="filterSpeedHistory()">
                            <select id="speedHistoryVehicle" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white text-sm focus:ring-2 focus:ring-warning focus:border-warning transition-all" onchange="filterSpeedHistory()">
                                <option value="">Todos os veículos</option>
                            </select>
                            <select id="speedHistoryStatus" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white text-sm focus:ring-2 focus:ring-warning focus:border-warning transition-all" onchange="filterSpeedHistory()">
                                <option value="">Todos os status</option>
                                <option value="Normal">Normal</option>
                                <option value="Infração">Infração</option>
                                <option value="Infração Grave">Infração Grave</option>
                            </select>
                            <button onclick="exportSpeedData()" class="px-3 py-2 bg-gradient-to-r from-success to-success/80 text-white rounded-lg hover:from-success/90 hover:to-success/70 transition-all duration-200 text-sm">
                                <i class="fas fa-file-excel mr-1"></i>Excel
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="sortSpeedRecords('datetime')">
                                        Data/Hora <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Veículo</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Turno</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Motorista</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors" onclick="sortSpeedRecords('speed')">
                                        Velocidade <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Limite</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Localização</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="speedHistoryTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Speed history will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Enhanced Pagination -->
                    <div id="speedPagination" class="mt-6 flex items-center justify-between bg-gray-50 dark:bg-gray-700 px-4 py-3 rounded-lg">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button onclick="previousSpeedPage()" id="speedPrevBtnMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Anterior
                            </button>
                            <button onclick="nextSpeedPage()" id="speedNextBtnMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Próximo
                            </button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700 dark:text-gray-300">
                                    Mostrando <span class="font-medium" id="speedShowingStart">0</span> a <span class="font-medium" id="speedShowingEnd">0</span> de <span class="font-medium" id="speedTotal">0</span> registros
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="previousSpeedPage()" id="speedPrevBtn" class="relative inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-chevron-left mr-1"></i>Anterior
                                </button>
                                <button onclick="nextSpeedPage()" id="speedNextBtn" class="ml-3 relative inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    Próximo<i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Reports Tab -->
        <div id="reports" class="tab-content hidden animate-fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Enhanced Report Filters -->
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-filter text-primary mr-2"></i>Filtros de Relatório
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Período</label>
                            <select id="reportPeriod" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" onchange="toggleCustomDateRange()">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 3 meses</option>
                                <option value="365">Último ano</option>
                                <option value="custom">Período personalizado</option>
                            </select>
                        </div>
                        
                        <div id="customDateRange" class="space-y-2 hidden">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data Inicial</label>
                            <input type="date" id="reportStartDate" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data Final</label>
                            <input type="date" id="reportEndDate" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Relatório</label>
                            <select id="reportType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="general">Relatório Geral</option>
                                <option value="speed">Infrações de Velocidade</option>
                                <option value="maintenance">Manutenção e Vencimentos</option>
                                <option value="drivers">Performance dos Motoristas</option>
                                <option value="vehicles">Status dos Veículos</option>
                                <option value="compliance">Relatório de Conformidade</option>
                                <option value="executive">Resumo Executivo</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Veículo</label>
                            <select id="reportVehicle" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Todos os veículos</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Formato</label>
                            <select id="reportFormat" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="html">HTML (Visualização)</option>
                                <option value="excel">Excel (Download)</option>
                                <option value="pdf">PDF (Download)</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="generateReport()" class="w-full bg-gradient-to-r from-primary to-primary/80 text-white px-4 py-3 rounded-lg hover:from-primary/90 hover:to-primary/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-chart-bar mr-2"></i>Gerar Relatório
                            </button>
                            
                            <button onclick="exportReport()" class="w-full bg-gradient-to-r from-success to-success/80 text-white px-4 py-3 rounded-lg hover:from-success/90 hover:to-success/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-file-excel mr-2"></i>Exportar Relatório
                            </button>
                            
                            <button onclick="scheduleReport()" class="w-full bg-gradient-to-r from-info to-info/80 text-white px-4 py-3 rounded-lg hover:from-info/90 hover:to-info/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-clock mr-2"></i>Agendar Relatório
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Report Content -->
                <div class="lg:col-span-3 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-primary/5 to-secondary/5">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-chart-line text-primary mr-2"></i>Relatório Gerado
                            </h3>
                            <div class="flex space-x-2">
                                <button onclick="printReport()" class="text-gray-400 hover:text-primary transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="Imprimir">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button onclick="shareReport()" class="text-gray-400 hover:text-primary transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="Compartilhar">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button onclick="refreshReport()" class="text-gray-400 hover:text-primary transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full" title="Atualizar">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="reportContent" class="min-h-96">
                            <div class="flex items-center justify-center h-64 text-gray-500 dark:text-gray-400">
                                <div class="text-center">
                                    <i class="fas fa-chart-line text-6xl mb-4 text-gray-300 dark:text-gray-600"></i>
                                    <p class="text-lg font-medium">Relatórios Avançados</p>
                                    <p class="text-sm mt-1">Selecione os filtros e clique em "Gerar Relatório" para visualizar os dados</p>
                                    <div class="mt-4 flex justify-center space-x-2">
                                        <div class="w-2 h-2 bg-primary rounded-full animate-bounce"></div>
                                        <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                        <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Backup & Data Tab -->
        <div id="backup" class="tab-content hidden animate-fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Enhanced Data Status -->
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-server text-success mr-2 animate-pulse"></i>Sistema de Dados
                    </h3>
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-success/10 to-info/10 p-4 rounded-lg border border-success/20">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-medium text-gray-900 dark:text-white">Status do Sistema</span>
                                <span class="text-xs px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200 rounded-full flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></div>Ativo
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                <div class="flex justify-between">
                                    <span>Total de registros:</span>
                                    <span id="totalRecords" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Última atualização:</span>
                                    <span id="lastUpdate" class="font-medium">Agora</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Tamanho dos dados:</span>
                                    <span id="dataSize" class="font-medium">0 KB</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Integridade:</span>
                                    <span class="font-medium text-green-600">100%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="forceSave()" class="w-full bg-gradient-to-r from-success to-success/80 text-white px-4 py-3 rounded-lg hover:from-success/90 hover:to-success/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-save mr-2"></i>Salvar Agora
                            </button>
                            
                            <button onclick="downloadAllData()" class="w-full bg-gradient-to-r from-primary to-primary/80 text-white px-4 py-3 rounded-lg hover:from-primary/90 hover:to-primary/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-download mr-2"></i>Backup Completo
                            </button>
                            
                            <button onclick="validateData()" class="w-full bg-gradient-to-r from-info to-info/80 text-white px-4 py-3 rounded-lg hover:from-info/90 hover:to-info/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-check-double mr-2"></i>Validar Dados
                            </button>
                            
                            <button onclick="clearAllData()" class="w-full bg-gradient-to-r from-danger to-danger/80 text-white px-4 py-3 rounded-lg hover:from-danger/90 hover:to-danger/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-trash mr-2"></i>Limpar Todos os Dados
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Import -->
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-upload text-info mr-2"></i>Importar Dados
                    </h3>
                    <div class="space-y-4">
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-info transition-all duration-300 cursor-pointer relative" id="dropZone">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Arraste o arquivo ou clique para selecionar</p>
                            <input type="file" id="importFileInput" accept=".json,.csv,.xlsx" class="hidden" onchange="handleFileSelect(event)">
                            <button onclick="document.getElementById('importFileInput').click()" class="bg-gradient-to-r from-info to-info/80 text-white px-4 py-2 rounded-lg hover:from-info/90 hover:to-info/70 transition-all duration-200 text-sm">
                                <i class="fas fa-file-upload mr-2"></i>Selecionar Arquivo
                            </button>
                            <div id="filePreview" class="hidden mt-3 text-left bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-file text-blue-500 mr-2"></i>
                                        <span id="fileName" class="text-sm font-medium"></span>
                                    </div>
                                    <button onclick="clearFileSelection()" class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="mt-2">
                                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                        <div id="uploadProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
                            <div class="flex">
                                <i class="fas fa-info-circle text-blue-500 mr-2 mt-0.5"></i>
                                <div class="text-xs text-blue-800 dark:text-blue-200">
                                    <p class="font-medium">Formatos suportados:</p>
                                    <ul class="list-disc list-inside mt-1">
                                        <li>JSON (backup do sistema)</li>
                                        <li>CSV (dados tabulares)</li>
                                        <li>XLSX (planilhas Excel)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-2">
                            <button onclick="importSampleData()" class="flex-1 bg-gradient-to-r from-warning to-warning/80 text-white px-4 py-3 rounded-lg hover:from-warning/90 hover:to-warning/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105 text-sm">
                                <i class="fas fa-database mr-2"></i>Dados de Exemplo
                            </button>
                            <button onclick="processImportFromFile()" class="flex-1 bg-gradient-to-r from-info to-info/80 text-white px-4 py-3 rounded-lg hover:from-info/90 hover:to-info/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105 text-sm">
                                <i class="fas fa-upload mr-2"></i>Importar Arquivo
                            </button>
                            <button onclick="showImportGuide()" class="px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-all duration-200 text-sm">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Export -->
                <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-download text-primary mr-2"></i>Exportar Dados
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Exportação</label>
                            <select id="exportType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="all">Todos os Dados</option>
                                <option value="vehicles">Apenas Veículos</option>
                                <option value="drivers">Apenas Motoristas</option>
                                <option value="speed">Apenas Velocidade</option>
                                <option value="activities">Apenas Atividades</option>
                                <option value="reports">Relatórios</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Formato</label>
                            <select id="exportFormat" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="json">JSON (Backup Completo)</option>
                                <option value="csv">CSV (Planilha)</option>
                                <option value="xlsx">XLSX (Excel)</option>
                                <option value="pdf">PDF (Relatório)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Período (para dados temporais)</label>
                            <select id="exportPeriod" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="all">Todos os períodos</option>
                                <option value="7">Últimos 7 dias</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 3 meses</option>
                                <option value="365">Último ano</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="exportSelectedData()" class="w-full bg-gradient-to-r from-primary to-primary/80 text-white px-4 py-3 rounded-lg hover:from-primary/90 hover:to-primary/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-download mr-2"></i>Exportar Dados
                            </button>
                            
                            <button onclick="scheduleBackup()" class="w-full bg-gradient-to-r from-secondary to-secondary/80 text-white px-4 py-3 rounded-lg hover:from-secondary/90 hover:to-secondary/70 transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                                <i class="fas fa-clock mr-2"></i>Agendar Backup
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Data Statistics -->
            <div class="mt-6 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                        <i class="fas fa-chart-bar text-primary mr-2"></i>Estatísticas dos Dados
                    </h3>
                    <div class="flex space-x-2">
                        <button onclick="refreshDataStats()" class="text-gray-400 hover:text-primary transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button onclick="analyzeDataTrends()" class="text-gray-400 hover:text-primary transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-lg border border-blue-200 dark:border-blue-800 hover:shadow-md transition-all duration-200">
                        <i class="fas fa-truck text-blue-500 text-2xl mb-2"></i>
                        <p class="text-sm text-blue-600 dark:text-blue-400 font-medium">Veículos</p>
                        <p class="text-2xl font-bold text-blue-700 dark:text-blue-300" id="statsVehicles">0</p>
                        <p class="text-xs text-blue-500 dark:text-blue-400 mt-1" id="vehiclesGrowth">+0% este mês</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 rounded-lg border border-green-200 dark:border-green-800 hover:shadow-md transition-all duration-200">
                        <i class="fas fa-users text-green-500 text-2xl mb-2"></i>
                        <p class="text-sm text-green-600 dark:text-green-400 font-medium">Motoristas</p>
                        <p class="text-2xl font-bold text-green-700 dark:text-green-300" id="statsDrivers">0</p>
                        <p class="text-xs text-green-500 dark:text-green-400 mt-1" id="driversGrowth">+0% este mês</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 rounded-lg border border-yellow-200 dark:border-yellow-800 hover:shadow-md transition-all duration-200">
                        <i class="fas fa-tachometer-alt text-yellow-500 text-2xl mb-2"></i>
                        <p class="text-sm text-yellow-600 dark:text-yellow-400 font-medium">Registros de Velocidade</p>
                        <p class="text-2xl font-bold text-yellow-700 dark:text-yellow-300" id="statsSpeed">0</p>
                        <p class="text-xs text-yellow-500 dark:text-yellow-400 mt-1" id="speedGrowth">+0% este mês</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-lg border border-purple-200 dark:border-purple-800 hover:shadow-md transition-all duration-200">
                        <i class="fas fa-clock text-purple-500 text-2xl mb-2"></i>
                        <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">Atividades</p>
                        <p class="text-2xl font-bold text-purple-700 dark:text-purple-300" id="statsActivities">0</p>
                        <p class="text-xs text-purple-500 dark:text-purple-400 mt-1" id="activitiesGrowth">+0% este mês</p>
                    </div>
                </div>
                
                <!-- Data Health Indicators -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Qualidade dos Dados</h4>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-500 dark:text-gray-400">Completude</span>
                            <span class="text-sm font-bold text-green-600" id="dataCompleteness">98%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-1000" id="completenessBar" style="width: 98%"></div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Consistência</h4>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-500 dark:text-gray-400">Validação</span>
                            <span class="text-sm font-bold text-blue-600" id="dataConsistency">95%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000" id="consistencyBar" style="width: 95%"></div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Atualização</h4>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-500 dark:text-gray-400">Recente</span>
                            <span class="text-sm font-bold text-purple-600" id="dataFreshness">100%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="bg-purple-500 h-2 rounded-full transition-all duration-1000" id="freshnessBar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Enhanced Modals -->
    <!-- Speed Entry Modal -->
    <div id="speedEntryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-lg w-full max-h-screen overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="speedEntryModalContent">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-tachometer-alt text-primary mr-2"></i>Registro Rápido de Velocidade
            </h3>
            <form id="quickSpeedForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Veículo <span class="text-red-500">*</span></label>
                        <select id="quickSpeedVehicle" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required onchange="updateQuickDriverOptions()">
                            <option value="">Selecione um veículo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno <span class="text-red-500">*</span></label>
                        <select id="quickSpeedShift" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required onchange="updateQuickDriverInfo()">
                            <option value="">Selecione o turno</option>
                            <option value="A">Turno A</option>
                            <option value="B">Turno B</option>
                            <option value="C">Turno C</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Motorista</label>
                    <input type="text" id="quickSpeedDriverInfo" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white bg-gray-50 dark:bg-gray-600" readonly placeholder="Motorista será exibido após selecionar veículo e turno">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Velocidade (km/h) <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="number" id="quickSpeedValue" min="0" max="200" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required oninput="updateSpeedIndicator()">
                            <div id="speedIndicator" class="absolute right-3 top-3 w-3 h-3 rounded-full bg-gray-400 transition-all duration-300"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Limite (km/h) <span class="text-red-500">*</span></label>
                        <select id="quickSpeedLimit" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required onchange="updateSpeedIndicator()">
                            <option value="30">30 km/h</option>
                            <option value="40">40 km/h</option>
                            <option value="50">50 km/h</option>
                            <option value="60">60 km/h</option>
                            <option value="80" selected>80 km/h</option>
                            <option value="100">100 km/h</option>
                            <option value="110">110 km/h</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data/Hora <span class="text-red-500">*</span></label>
                        <input type="datetime-local" id="quickSpeedDateTime" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Localização <span class="text-red-500">*</span></label>
                        <input type="text" id="quickSpeedLocation" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="Ex: BR-101, KM 245" required>
                    </div>
                </div>
                
                <div id="speedStatusPreview" class="hidden bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Status previsto:</span>
                        <span id="speedStatusText" class="text-sm font-medium"></span>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeSpeedEntryModal()" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200">Cancelar</button>
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-primary to-primary/80 text-white hover:from-primary/90 hover:to-primary/70 rounded-lg transition-all duration-200 font-medium transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>Registrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="addVehicleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="addVehicleModalContent">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-truck text-primary mr-2"></i>Adicionar Veículo
            </h3>
            <form id="addVehicleForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Número da Frota <span class="text-red-500">*</span></label>
                        <input type="text" id="vehicleFleetNumber" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="Ex: FR-001" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Placa <span class="text-red-500">*</span></label>
                        <input type="text" id="vehiclePlate" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="ABC-1234" required oninput="validatePlate(this)">
                        <div id="plateValidation" class="text-xs mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Modelo <span class="text-red-500">*</span></label>
                        <input type="text" id="vehicleModel" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="Ex: Volvo FH 540" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ano</label>
                        <input type="number" id="vehicleYear" min="1990" max="2030" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="2023">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cor</label>
                        <input type="text" id="vehicleColor" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="Branco">
                    </div>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-6">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-users text-info mr-2"></i>Motoristas por Turno
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno A</label>
                            <select id="vehicleDriverA" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Selecione um motorista</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno B</label>
                            <select id="vehicleDriverB" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Selecione um motorista</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno C</label>
                            <select id="vehicleDriverC" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Selecione um motorista</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vencimento do Tacógrafo <span class="text-red-500">*</span></label>
                        <input type="date" id="vehicleTachograph" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data da Inspeção <span class="text-red-500">*</span></label>
                        <input type="date" id="vehicleInspection" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddVehicleModal()" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200">Cancelar</button>
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-primary to-primary/80 text-white hover:from-primary/90 hover:to-primary/70 rounded-lg transition-all duration-200 font-medium transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Driver Modal -->
    <div id="addDriverModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-lg w-full max-h-screen overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="addDriverModalContent">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-user-plus text-primary mr-2"></i>Adicionar Motorista
            </h3>
            <form id="addDriverForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome Completo <span class="text-red-500">*</span></label>
                    <input type="text" id="driverName" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="Nome completo" required>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CNH <span class="text-red-500">*</span></label>
                        <input type="text" id="driverLicense" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="12345678901" required oninput="validateCNH(this)">
                        <div id="cnhValidation" class="text-xs mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria <span class="text-red-500">*</span></label>
                        <select id="driverCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                            <option value="">Selecione</option>
                            <option value="A">A - Motocicleta</option>
                            <option value="B">B - Carro</option>
                            <option value="C">C - Caminhão</option>
                            <option value="D">D - Ônibus</option>
                            <option value="E">E - Carreta</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data de Nascimento</label>
                        <input type="date" id="driverBirthDate" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vencimento da CNH <span class="text-red-500">*</span></label>
                        <input type="date" id="driverLicenseExpiry" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Telefone</label>
                        <input type="tel" id="driverPhone" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="(11) 99999-9999" oninput="formatPhone(this)">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                        <input type="email" id="driverEmail" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="email@exemplo.com">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddDriverModal()" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200">Cancelar</button>
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-primary to-primary/80 text-white hover:from-primary/90 hover:to-primary/70 rounded-lg transition-all duration-200 font-medium transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Vehicle Modal -->
    <div id="editVehicleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="editVehicleModalContent">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-edit text-primary mr-2"></i>Editar Veículo
            </h3>
            <form id="editVehicleForm" class="space-y-4">
                <input type="hidden" id="editVehicleId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Número da Frota <span class="text-red-500">*</span></label>
                        <input type="text" id="editVehicleFleetNumber" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Placa <span class="text-red-500">*</span></label>
                        <input type="text" id="editVehiclePlate" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required oninput="validatePlate(this)">
                        <div id="editPlateValidation" class="text-xs mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Modelo <span class="text-red-500">*</span></label>
                        <input type="text" id="editVehicleModel" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ano</label>
                        <input type="number" id="editVehicleYear" min="1990" max="2030" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cor</label>
                        <input type="text" id="editVehicleColor" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                    </div>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-6">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-users text-info mr-2"></i>Motoristas por Turno
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno A</label>
                            <select id="editVehicleDriverA" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Selecione um motorista</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno B</label>
                            <select id="editVehicleDriverB" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Selecione um motorista</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Turno C</label>
                            <select id="editVehicleDriverC" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                <option value="">Selecione um motorista</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vencimento do Tacógrafo <span class="text-red-500">*</span></label>
                        <input type="date" id="editVehicleTachograph" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data da Inspeção <span class="text-red-500">*</span></label>
                        <input type="date" id="editVehicleInspection" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditVehicleModal()" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200">Cancelar</button>
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-primary to-primary/80 text-white hover:from-primary/90 hover:to-primary/70 rounded-lg transition-all duration-200 font-medium transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Driver Modal -->
    <div id="editDriverModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-lg w-full max-h-screen overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="editDriverModalContent">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-edit text-primary mr-2"></i>Editar Motorista
            </h3>
            <form id="editDriverForm" class="space-y-4">
                <input type="hidden" id="editDriverId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome Completo <span class="text-red-500">*</span></label>
                    <input type="text" id="editDriverName" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">CNH <span class="text-red-500">*</span></label>
                        <input type="text" id="editDriverLicense" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required oninput="validateCNH(this)">
                        <div id="editCnhValidation" class="text-xs mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria <span class="text-red-500">*</span></label>
                        <select id="editDriverCategory" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                            <option value="A">A - Motocicleta</option>
                            <option value="B">B - Carro</option>
                            <option value="C">C - Caminhão</option>
                            <option value="D">D - Ônibus</option>
                            <option value="E">E - Carreta</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data de Nascimento</label>
                        <input type="date" id="editDriverBirthDate" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vencimento da CNH <span class="text-red-500">*</span></label>
                        <input type="date" id="editDriverLicenseExpiry" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Telefone</label>
                        <input type="tel" id="editDriverPhone" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="(11) 99999-9999" oninput="formatPhone(this)">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                        <input type="email" id="editDriverEmail" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="email@exemplo.com">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditDriverModal()" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200">Cancelar</button>
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-primary to-primary/80 text-white hover:from-primary/90 hover:to-primary/70 rounded-lg transition-all duration-200 font-medium transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i>Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced Import Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-lg w-full max-h-screen overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="importModalContent">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-upload text-info mr-2"></i>Importar Dados
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Importação</label>
                    <select id="importType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-info focus:border-info transition-all">
                        <option value="auto">Detectar automaticamente</option>
                        <option value="vehicles">Apenas Veículos</option>
                        <option value="drivers">Apenas Motoristas</option>
                        <option value="speed">Apenas Velocidade</option>
                        <option value="full">Backup Completo</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecionar Arquivo</label>
                    <input type="file" id="modalImportFile" accept=".json,.csv,.xlsx" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-info focus:border-info transition-all">
                </div>
                
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="importOverwrite" class="rounded border-gray-300 dark:border-gray-600 text-info focus:ring-info">
                    <label for="importOverwrite" class="text-sm text-gray-700 dark:text-gray-300">Sobrescrever dados existentes</label>
                </div>
                
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
                    <div class="flex">
                        <i class="fas fa-info-circle text-blue-500 mr-2 mt-0.5"></i>
                        <div class="text-xs text-blue-800 dark:text-blue-200">
                            <p class="font-medium">Formatos suportados:</p>
                            <ul class="list-disc list-inside mt-1">
                                <li>JSON (backup do sistema)</li>
                                <li>CSV (dados tabulares)</li>
                                <li>XLSX (planilhas Excel)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeImportModal()" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200">Cancelar</button>
                <button onclick="processImport()" class="px-6 py-3 bg-gradient-to-r from-info to-info/80 text-white hover:from-info/90 hover:to-info/70 rounded-lg transition-all duration-200 font-medium transform hover:scale-105">
                    <i class="fas fa-upload mr-2"></i>Importar
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="settingsModalContent">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                <i class="fas fa-cog text-primary mr-2"></i>Configurações do Sistema
            </h3>
            
            <div class="space-y-6">
                <!-- General Settings -->
                <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                        <i class="fas fa-sliders-h text-primary mr-2"></i>Configurações Gerais
                    </h4>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="autoSaveEnabled" checked class="mr-3 rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary">
                            <span class="text-gray-700 dark:text-gray-300">Ativar salvamento automático</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="notificationsEnabled" checked class="mr-3 rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary">
                            <span class="text-gray-700 dark:text-gray-300">Ativar notificações</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="soundNotifications" class="mr-3 rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary">
                            <span class="text-gray-700 dark:text-gray-300">Notificações sonoras</span>
                        </label>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Itens por página</label>
                                <select id="itemsPerPage" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                    <option value="10">10 itens</option>
                                    <option value="25" selected>25 itens</option>
                                    <option value="50">50 itens</option>
                                    <option value="100">100 itens</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tema da interface</label>
                                <select id="themeSelector" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                    <option value="auto">Automático</option>
                                    <option value="light">Claro</option>
                                    <option value="dark">Escuro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Alert Settings -->
                <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                        <i class="fas fa-bell text-warning mr-2"></i>Configurações de Alertas
                    </h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Antecedência de vencimentos (dias)</label>
                            <input type="number" id="alertDays" min="1" max="90" value="30" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded text-base dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                        </div>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="emailAlerts" class="mr-3 rounded border-gray-300 dark:border-gray-600 text-warning focus:ring-warning">
                            <span class="text-gray-700 dark:text-gray-300">Alertas por email</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" id="speedAlerts" checked class="mr-3 rounded border-gray-300 dark:border-gray-600 text-warning focus:ring-warning">
                            <span class="text-gray-700 dark:text-gray-300">Alertas de velocidade</span>
                        </label>
                    </div>
                </div>
                
                <!-- System Info -->
                <div>
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3 flex items-center">
                        <i class="fas fa-info-circle text-info mr-2"></i>Informações do Sistema
                    </h4>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <p><strong>Versão:</strong> FleetControl Pro v3.0</p>
                                <p><strong>Última atualização:</strong> <span id="lastSystemUpdate">Agora</span></p>
                            </div>
                            <div>
                                <p><strong>Navegador:</strong> <span id="browserInfo">-</span></p>
                                <p><strong>Resolução:</strong> <span id="screenResolution">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="resetSettings()" class="px-6 py-3 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all duration-200">Restaurar Padrão</button>
                <button onclick="closeSettingsModal()" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200">Cancelar</button>
                <button onclick="saveSettings()" class="px-6 py-3 bg-gradient-to-r from-primary to-primary/80 text-white hover:from-primary/90 hover:to-primary/70 rounded-lg transition-all duration-200 font-medium transform hover:scale-105">
                    <i class="fas fa-save mr-2"></i>Salvar Configurações
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Enhanced animations and styles */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Enhanced tab content animation */
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* Enhanced navigation active state */
        .nav-btn.active-tab {
            border-bottom-color: #5D5CDE !important;
            color: #5D5CDE !important;
            background: linear-gradient(to bottom, rgba(93, 92, 222, 0.05), transparent);
        }
        
        /* Enhanced custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, rgba(156, 163, 175, 0.5), rgba(156, 163, 175, 0.8));
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, rgba(156, 163, 175, 0.8), rgba(156, 163, 175, 1));
        }

        /* Enhanced modal animations */
        .modal-show {
            animation: scaleIn 0.3s ease-out;
        }

        /* Enhanced loading states */
        .loading-pulse {
            animation: pulse 2s infinite;
        }

        /* Enhanced hover effects */
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        /* Enhanced gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(255, 107, 53, 0.1));
        }

        /* Enhanced button styles */
        .btn-enhanced {
            background: linear-gradient(135deg, #5D5CDE, #4F46E5);
            transition: all 0.3s ease;
        }

        .btn-enhanced:hover {
            background: linear-gradient(135deg, #4F46E5, #5D5CDE);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(93, 92, 222, 0.4);
        }

        /* Enhanced table styles */
        .table-enhanced tbody tr:hover {
            background: linear-gradient(90deg, rgba(93, 92, 222, 0.05), rgba(93, 92, 222, 0.02));
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        /* Enhanced notification styles */
        .notification-bounce {
            animation: bounce 0.6s ease-in-out;
        }

        /* Enhanced progress bars */
        .progress-bar {
            background: linear-gradient(90deg, #10B981, #059669);
            transition: width 0.5s ease-in-out;
        }

        /* Enhanced input focus states */
        .input-enhanced:focus {
            border-color: #5D5CDE;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        /* Enhanced card hover effects */
        .card-enhanced:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        /* Enhanced responsive design */
        @media (max-width: 768px) {
            .mobile-enhanced {
                padding: 1rem;
                margin: 0.5rem;
            }
            
            .table-enhanced {
                font-size: 0.875rem;
            }
            
            .btn-enhanced {
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
            }
        }

        /* Dark mode enhancements */
        .dark .gradient-bg {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.2), rgba(255, 107, 53, 0.2));
        }

        /* Enhanced loading overlay */
        .loading-overlay {
            backdrop-filter: blur(4px);
            background: rgba(0, 0, 0, 0.6);
        }

        /* Enhanced success/error states */
        .success-state {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            border-left: 4px solid #10B981;
        }

        .error-state {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border-left: 4px solid #EF4444;
        }

        .warning-state {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            border-left: 4px solid #F59E0B;
        }
    </style>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // ========================================
        // ENHANCED APPLICATION DATA MANAGER V3.0 WITH VEHICLE-BASED MONITORING
        // ========================================
        
        class FleetControlAppV3 {
            constructor() {
                // Initialize data structures
                this.storageKey = 'FleetControlProV3_Data';
                this.settingsKey = 'FleetControlProV3_Settings';
                
                // Default data structure
                this.defaultData = {
                    vehicles: [],
                    drivers: [],
                    speedRecords: [],
                    recentActivities: [],
                    notifications: [],
                    version: '3.0',
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };

                // Default settings
                this.defaultSettings = {
                    autoSave: true,
                    notificationsEnabled: true,
                    soundNotifications: false,
                    emailAlerts: false,
                    speedAlerts: true,
                    itemsPerPage: 25,
                    alertDays: 30,
                    theme: 'auto'
                };
                
                // Load data from localStorage or use defaults
                this.data = this.loadData();
                this.settings = this.loadSettings();
                
                // Enhanced pagination and filtering states
                this.pagination = {
                    vehicles: { currentPage: 1, itemsPerPage: this.settings.itemsPerPage },
                    drivers: { currentPage: 1, itemsPerPage: this.settings.itemsPerPage },
                    speedRecords: { currentPage: 1, itemsPerPage: this.settings.itemsPerPage }
                };
                
                this.filters = {
                    vehicles: { search: '', status: '', year: '' },
                    drivers: { search: '', category: '', status: '' },
                    speedRecords: { date: '', vehicle: '', status: '' }
                };
                
                this.sorting = {
                    vehicles: { field: 'fleetNumber', direction: 'asc' },
                    drivers: { field: 'name', direction: 'asc' },
                    speedRecords: { field: 'datetime', direction: 'desc' }
                };
                
                this.charts = {
                    documents: null,
                    violations: null
                };

                // Enhanced debounce functions
                this.debounceTimers = {};
                
                this.init();
            }

            // ========================================
            // ENHANCED PERSISTENCE METHODS
            // ========================================

            loadData() {
                try {
                    const savedData = localStorage.getItem(this.storageKey);
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        // Validate and merge with default structure
                        return {
                            ...this.defaultData,
                            ...parsedData,
                            lastLoaded: new Date().toISOString()
                        };
                    }
                } catch (error) {
                    console.warn('Erro ao carregar dados salvos:', error);
                    this.addNotification('Aviso', 'Erro ao carregar dados salvos. Iniciando com dados limpos.', 'warning');
                }
                return { ...this.defaultData };
            }

            loadSettings() {
                try {
                    const savedSettings = localStorage.getItem(this.settingsKey);
                    if (savedSettings) {
                        const parsedSettings = JSON.parse(savedSettings);
                        return { ...this.defaultSettings, ...parsedSettings };
                    }
                } catch (error) {
                    console.warn('Erro ao carregar configurações:', error);
                }
                return { ...this.defaultSettings };
            }

            saveData() {
                try {
                    this.data.lastModified = new Date().toISOString();
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    this.updateSaveStatus('success');
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar dados:', error);
                    this.updateSaveStatus('error');
                    this.addNotification('Erro', 'Falha ao salvar dados automaticamente', 'error');
                    return false;
                }
            }

            saveSettings() {
                try {
                    localStorage.setItem(this.settingsKey, JSON.stringify(this.settings));
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar configurações:', error);
                    return false;
                }
            }

            updateSaveStatus(status) {
                const saveStatus = document.getElementById('saveStatus');
                const saveStatusText = document.getElementById('saveStatusText');
                
                if (saveStatus && saveStatusText) {
                    if (status === 'success') {
                        saveStatus.className = 'w-3 h-3 rounded-full bg-green-500';
                        saveStatusText.textContent = 'Dados salvos';
                    } else if (status === 'error') {
                        saveStatus.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
                        saveStatusText.textContent = 'Erro ao salvar';
                    } else {
                        saveStatus.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                        saveStatusText.textContent = 'Salvando...';
                    }
                }
            }

            // Auto-save when data changes
            autoSave() {
                if (this.settings.autoSave) {
                    this.updateSaveStatus('saving');
                    setTimeout(() => {
                        this.saveData();
                    }, 500);
                }
            }

            init() {
                // Initialize the enhanced application
                this.addActivity('Sistema FleetControl Pro v3.0 inicializado', 'fa-rocket', 'success');
                
                // Check if this is first run
                if (this.data.vehicles.length === 0 && this.data.drivers.length === 0) {
                    this.addNotification('Bem-vindo!', 'FleetControl Pro v3.0 iniciado. Monitoramento agora é por veículo.', 'info');
                } else {
                    this.addNotification('Sistema Carregado', `Dados carregados: ${this.data.vehicles.length} veículos, ${this.data.drivers.length} motoristas`, 'success');
                }
                
                this.populateSystemInfo();
                this.autoSave();
            }

            // ========================================
            // ENHANCED CRUD OPERATIONS WITH VEHICLE SHIFT SUPPORT
            // ========================================

            // Enhanced Vehicles CRUD with shift support
            addVehicle(vehicleData) {
                // Validate data
                if (!this.validateVehicleData(vehicleData)) {
                    throw new Error('Dados do veículo inválidos');
                }

                const newVehicle = {
                    ...vehicleData,
                    id: Math.max(...this.data.vehicles.map(v => v.id), 0) + 1,
                    status: this.calculateVehicleStatus(vehicleData.tachographExpiry, vehicleData.inspectionDate),
                    fuelType: vehicleData.fuelType || 'Diesel',
                    lastMaintenance: vehicleData.lastMaintenance || new Date().toISOString().split('T')[0],
                    // Support for shift-based drivers
                    driverShiftA: vehicleData.driverShiftA || '',
                    driverShiftB: vehicleData.driverShiftB || '',
                    driverShiftC: vehicleData.driverShiftC || '',
                    createdAt: new Date().toISOString()
                };
                
                this.data.vehicles.push(newVehicle);
                this.addActivity(`Novo veículo adicionado: Frota ${newVehicle.fleetNumber} - ${newVehicle.plate}`, 'fa-truck', 'success');
                this.addNotification('Veículo adicionado', `Veículo ${newVehicle.plate} foi adicionado com sucesso`, 'success');
                this.autoSave();
                return newVehicle;
            }

            updateVehicle(id, updates) {
                const vehicleIndex = this.data.vehicles.findIndex(v => v.id === id);
                if (vehicleIndex === -1) return false;
                
                // Validate updates
                if (!this.validateVehicleData(updates, true)) {
                    throw new Error('Dados de atualização inválidos');
                }
                
                Object.assign(this.data.vehicles[vehicleIndex], updates);
                this.data.vehicles[vehicleIndex].status = this.calculateVehicleStatus(
                    this.data.vehicles[vehicleIndex].tachographExpiry,
                    this.data.vehicles[vehicleIndex].inspectionDate
                );
                this.data.vehicles[vehicleIndex].updatedAt = new Date().toISOString();
                
                this.addActivity(`Veículo atualizado: ${this.data.vehicles[vehicleIndex].plate}`, 'fa-edit', 'info');
                this.autoSave();
                return this.data.vehicles[vehicleIndex];
            }

            removeVehicle(id) {
                const vehicleIndex = this.data.vehicles.findIndex(v => v.id === id);
                if (vehicleIndex === -1) return false;
                
                const vehicle = this.data.vehicles[vehicleIndex];
                this.data.vehicles.splice(vehicleIndex, 1);
                this.addActivity(`Veículo removido: ${vehicle.plate}`, 'fa-trash', 'danger');
                this.addNotification('Veículo removido', `Veículo ${vehicle.plate} foi removido`, 'warning');
                this.autoSave();
                return true;
            }

            // Enhanced Drivers CRUD (unchanged)
            addDriver(driverData) {
                // Validate data
                if (!this.validateDriverData(driverData)) {
                    throw new Error('Dados do motorista inválidos');
                }

                const newDriver = {
                    ...driverData,
                    id: Math.max(...this.data.drivers.map(d => d.id), 0) + 1,
                    status: 'Ativo',
                    hireDate: driverData.hireDate || new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString()
                };
                
                this.data.drivers.push(newDriver);
                this.addActivity(`Novo motorista adicionado: ${newDriver.name}`, 'fa-user-plus', 'info');
                this.addNotification('Motorista adicionado', `Motorista ${newDriver.name} foi adicionado com sucesso`, 'success');
                this.autoSave();
                return newDriver;
            }

            updateDriver(id, updates) {
                const driverIndex = this.data.drivers.findIndex(d => d.id === id);
                if (driverIndex === -1) return false;
                
                // Validate updates
                if (!this.validateDriverData(updates, true)) {
                    throw new Error('Dados de atualização inválidos');
                }
                
                Object.assign(this.data.drivers[driverIndex], updates);
                this.data.drivers[driverIndex].updatedAt = new Date().toISOString();
                this.addActivity(`Motorista atualizado: ${this.data.drivers[driverIndex].name}`, 'fa-edit', 'info');
                this.autoSave();
                return this.data.drivers[driverIndex];
            }

            removeDriver(id) {
                const driverIndex = this.data.drivers.findIndex(d => d.id === id);
                if (driverIndex === -1) return false;
                
                const driver = this.data.drivers[driverIndex];
                this.data.drivers.splice(driverIndex, 1);
                this.addActivity(`Motorista removido: ${driver.name}`, 'fa-trash', 'danger');
                this.addNotification('Motorista removido', `Motorista ${driver.name} foi removido`, 'warning');
                this.autoSave();
                return true;
            }

            // Enhanced Speed Records CRUD - NOW BY VEHICLE
            addSpeedRecord(recordData) {
                // Validate data
                if (!this.validateSpeedRecord(recordData)) {
                    throw new Error('Dados de velocidade inválidos');
                }

                // Find vehicle
                const vehicle = this.data.vehicles.find(v => v.id === recordData.vehicleId);
                if (!vehicle) {
                    throw new Error('Veículo não encontrado');
                }

                // Get driver info based on shift
                const driverName = this.getDriverNameByShift(vehicle, recordData.shift);

                const newRecord = {
                    ...recordData,
                    id: Math.max(...this.data.speedRecords.map(r => r.id), 0) + 1,
                    vehiclePlate: vehicle.plate,
                    vehicleFleetNumber: vehicle.fleetNumber,
                    driverName: driverName,
                    weather: recordData.weather || 'N/A',
                    trafficCondition: recordData.trafficCondition || 'N/A',
                    createdAt: new Date().toISOString()
                };
                
                this.data.speedRecords.push(newRecord);
                this.addActivity(`Velocidade registrada: ${vehicle.plate} (${recordData.shift}) - ${newRecord.speed}km/h`, 'fa-tachometer-alt', 'primary');
                
                if (newRecord.status !== 'Normal') {
                    const alertLevel = newRecord.status.includes('Grave') ? 'error' : 'warning';
                    this.addNotification('Infração de velocidade', 
                        `${vehicle.plate} - Turno ${recordData.shift} - ${newRecord.speed}km/h (Limite: ${newRecord.speedLimit}km/h)`, 
                        alertLevel);
                }
                
                this.autoSave();
                return newRecord;
            }

            getDriverNameByShift(vehicle, shift) {
                const shiftMap = {
                    'A': vehicle.driverShiftA,
                    'B': vehicle.driverShiftB,
                    'C': vehicle.driverShiftC
                };
                
                const driverId = shiftMap[shift];
                if (driverId) {
                    const driver = this.data.drivers.find(d => d.id === parseInt(driverId));
                    return driver ? driver.name : `Motorista Turno ${shift}`;
                }
                return `Motorista Turno ${shift}`;
            }

            removeSpeedRecord(id) {
                const recordIndex = this.data.speedRecords.findIndex(r => r.id === id);
                if (recordIndex === -1) return false;
                
                this.data.speedRecords.splice(recordIndex, 1);
                this.addActivity('Registro de velocidade removido', 'fa-trash', 'danger');
                this.autoSave();
                return true;
            }

            // ========================================
            // ENHANCED VALIDATION FUNCTIONS
            // ========================================

            validateVehicleData(data, isUpdate = false) {
                if (!isUpdate) {
                    if (!data.fleetNumber || !data.plate || !data.model || !data.tachographExpiry || !data.inspectionDate) {
                        return false;
                    }
                }
                
                // Validate plate format (Brazilian pattern)
                if (data.plate && !this.validatePlateFormat(data.plate)) {
                    return false;
                }
                
                // Check for duplicate plates
                if (data.plate) {
                    const existingVehicle = this.data.vehicles.find(v => 
                        v.plate === data.plate && (!isUpdate || v.id !== data.id)
                    );
                    if (existingVehicle) {
                        throw new Error('Já existe um veículo com esta placa');
                    }
                }

                // Check for duplicate fleet numbers
                if (data.fleetNumber) {
                    const existingVehicle = this.data.vehicles.find(v => 
                        v.fleetNumber === data.fleetNumber && (!isUpdate || v.id !== data.id)
                    );
                    if (existingVehicle) {
                        throw new Error('Já existe um veículo com este número de frota');
                    }
                }
                
                return true;
            }

            validateDriverData(data, isUpdate = false) {
                if (!isUpdate) {
                    if (!data.name || !data.license || !data.category || !data.licenseExpiry) {
                        return false;
                    }
                }
                
                // Validate CNH format
                if (data.license && !this.validateCNHFormat(data.license)) {
                    return false;
                }
                
                // Check for duplicate CNH
                if (data.license) {
                    const existingDriver = this.data.drivers.find(d => 
                        d.license === data.license && (!isUpdate || d.id !== data.id)
                    );
                    if (existingDriver) {
                        throw new Error('Já existe um motorista com esta CNH');
                    }
                }
                
                // Validate email if provided
                if (data.email && !this.validateEmail(data.email)) {
                    return false;
                }
                
                return true;
            }

            validateSpeedRecord(data) {
                if (!data.vehicleId || !data.shift || !data.speed || !data.speedLimit || !data.datetime || !data.location) {
                    return false;
                }
                
                // Validate speed values
                if (data.speed < 0 || data.speed > 200 || data.speedLimit < 0 || data.speedLimit > 200) {
                    return false;
                }
                
                // Validate vehicle exists
                const vehicle = this.data.vehicles.find(v => v.id === data.vehicleId);
                if (!vehicle) {
                    return false;
                }

                // Validate shift
                if (!['A', 'B', 'C'].includes(data.shift)) {
                    return false;
                }
                
                return true;
            }

            validatePlateFormat(plate) {
                // Brazilian plate format: ABC-1234 or ABC1D234 (Mercosul)
                const oldFormat = /^[A-Z]{3}-\d{4}$/;
                const newFormat = /^[A-Z]{3}\d[A-Z]\d{3}$/;
                return oldFormat.test(plate) || newFormat.test(plate);
            }

            validateCNHFormat(cnh) {
                // CNH should be 11 digits
                return /^\d{11}$/.test(cnh.replace(/\D/g, ''));
            }

            validateEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            // ========================================
            // ENHANCED UTILITY FUNCTIONS
            // ========================================

            calculateVehicleStatus(tachographExpiry, inspectionDate) {
                const today = new Date();
                const alertDays = this.settings.alertDays;
                const alertDate = new Date(today.getTime() + (alertDays * 24 * 60 * 60 * 1000));
                
                const tachographDate = new Date(tachographExpiry);
                const inspectionExpiry = new Date(new Date(inspectionDate).getTime() + (2 * 365 * 24 * 60 * 60 * 1000));
                
                if (tachographDate < today || inspectionExpiry < today) {
                    return 'Vencido';
                } else if (tachographDate < alertDate || inspectionExpiry < alertDate) {
                    return 'A vencer';
                } else {
                    return 'Em dia';
                }
            }

            addActivity(message, icon, color) {
                this.data.recentActivities.unshift({
                    id: Date.now(),
                    message,
                    icon,
                    color,
                    datetime: new Date().toISOString()
                });
                
                // Keep only last 100 activities
                if (this.data.recentActivities.length > 100) {
                    this.data.recentActivities = this.data.recentActivities.slice(0, 100);
                }
                
                // Auto-save activities
                this.autoSave();
            }

            addNotification(title, message, type = 'info') {
                if (!this.settings.notificationsEnabled) return;

                const notification = {
                    id: Date.now(),
                    title,
                    message,
                    type,
                    datetime: new Date().toISOString(),
                    read: false
                };

                this.data.notifications.unshift(notification);
                
                // Keep only last 50 notifications
                if (this.data.notifications.length > 50) {
                    this.data.notifications = this.data.notifications.slice(0, 50);
                }
                
                // Play sound if enabled
                if (this.settings.soundNotifications) {
                    this.playNotificationSound(type);
                }
                
                this.updateNotificationCounter();
                this.autoSave();
            }

            playNotificationSound(type) {
                // Create audio context for notifications
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // Different frequencies for different notification types
                    const frequencies = {
                        success: 523.25,  // C5
                        warning: 440.00,  // A4
                        error: 329.63,    // E4
                        info: 659.25      // E5
                    };
                    
                    oscillator.frequency.setValueAtTime(frequencies[type] || frequencies.info, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (error) {
                    console.log('Audio context not supported');
                }
            }

            markAllNotificationsAsRead() {
                this.data.notifications.forEach(n => n.read = true);
                this.updateNotificationCounter();
                this.autoSave();
            }

            clearAllNotifications() {
                this.data.notifications = [];
                this.updateNotificationCounter();
                this.autoSave();
            }

            updateNotificationCounter() {
                const badge = document.getElementById('alertBadge');
                const count = document.getElementById('notificationCount');
                const unreadCount = this.data.notifications.filter(n => !n.read).length;
                
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.classList.remove('hidden');
                        badge.classList.add('animate-bounce');
                    } else {
                        badge.classList.add('hidden');
                        badge.classList.remove('animate-bounce');
                    }
                }

                if (count) {
                    count.textContent = unreadCount;
                }
            }

            getStats() {
                return {
                    totalVehicles: this.data.vehicles.length,
                    totalDrivers: this.data.drivers.length,
                    totalSpeedRecords: this.data.speedRecords.length,
                    totalActivities: this.data.recentActivities.length,
                    unreadNotifications: this.data.notifications.filter(n => !n.read).length
                };
            }

            // ========================================
            // ENHANCED SEARCH AND FILTER FUNCTIONS
            // ========================================

            searchVehicles(searchTerm = '', statusFilter = '', yearFilter = '') {
                let filtered = this.data.vehicles;
                
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(vehicle =>
                        vehicle.plate.toLowerCase().includes(term) ||
                        vehicle.model.toLowerCase().includes(term) ||
                        (vehicle.fleetNumber && vehicle.fleetNumber.toLowerCase().includes(term)) ||
                        (vehicle.color && vehicle.color.toLowerCase().includes(term))
                    );
                }
                
                if (statusFilter) {
                    filtered = filtered.filter(vehicle => vehicle.status === statusFilter);
                }

                if (yearFilter) {
                    filtered = filtered.filter(vehicle => vehicle.year && vehicle.year.toString() === yearFilter);
                }
                
                return this.applySorting(filtered, 'vehicles');
            }

            searchDrivers(searchTerm = '', categoryFilter = '', statusFilter = '') {
                let filtered = this.data.drivers;
                
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(driver =>
                        driver.name.toLowerCase().includes(term) ||
                        driver.license.includes(term) ||
                        (driver.email && driver.email.toLowerCase().includes(term)) ||
                        (driver.phone && driver.phone.includes(term))
                    );
                }
                
                if (categoryFilter) {
                    filtered = filtered.filter(driver => driver.category === categoryFilter);
                }

                if (statusFilter) {
                    filtered = filtered.filter(driver => driver.status === statusFilter);
                }
                
                return this.applySorting(filtered, 'drivers');
            }

            searchSpeedRecords(filters = {}) {
                let filtered = this.data.speedRecords;
                
                if (filters.date) {
                    filtered = filtered.filter(record => 
                        record.datetime.startsWith(filters.date)
                    );
                }
                
                if (filters.vehicle) {
                    filtered = filtered.filter(record => 
                        record.vehicleId === parseInt(filters.vehicle)
                    );
                }
                
                if (filters.status) {
                    filtered = filtered.filter(record => record.status === filters.status);
                }
                
                return this.applySorting(filtered, 'speedRecords');
            }

            applySorting(data, type) {
                const sorting = this.sorting[type];
                if (!sorting || !sorting.field) return data;

                return data.sort((a, b) => {
                    let aVal = a[sorting.field];
                    let bVal = b[sorting.field];

                    // Handle different data types
                    if (sorting.field === 'datetime' || sorting.field.includes('Date') || sorting.field.includes('Expiry')) {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    } else if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }

                    if (aVal < bVal) return sorting.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sorting.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // ========================================
            // ENHANCED DATA EXPORT/IMPORT FUNCTIONS
            // ========================================

            exportData(type = 'all', format = 'json', period = 'all') {
                let dataToExport = {};
                let filename = '';
                
                // Filter by period for temporal data
                const filteredSpeedRecords = this.filterByPeriod(this.data.speedRecords, period);
                const filteredActivities = this.filterByPeriod(this.data.recentActivities, period);
                
                switch (type) {
                    case 'vehicles':
                        dataToExport = { vehicles: this.data.vehicles };
                        filename = 'fleetcontrol-vehicles';
                        break;
                    case 'drivers':
                        dataToExport = { drivers: this.data.drivers };
                        filename = 'fleetcontrol-drivers';
                        break;
                    case 'speed':
                        dataToExport = { speedRecords: filteredSpeedRecords };
                        filename = 'fleetcontrol-speed-records';
                        break;
                    case 'activities':
                        dataToExport = { recentActivities: filteredActivities };
                        filename = 'fleetcontrol-activities';
                        break;
                    case 'reports':
                        dataToExport = this.generateReportData(period, 'general');
                        filename = 'fleetcontrol-report';
                        break;
                    default:
                        dataToExport = {
                            ...this.data,
                            speedRecords: filteredSpeedRecords,
                            recentActivities: filteredActivities
                        };
                        filename = 'fleetcontrol-backup';
                        break;
                }
                
                const exportInfo = {
                    exported: new Date().toISOString(),
                    version: '3.0',
                    type: type,
                    format: format,
                    period: period
                };
                
                dataToExport._export = exportInfo;
                
                if (format === 'json') {
                    this.downloadFile(
                        JSON.stringify(dataToExport, null, 2),
                        `${filename}-${new Date().toISOString().slice(0, 10)}.json`,
                        'application/json'
                    );
                } else if (format === 'csv') {
                    const csvContent = this.convertToCSV(dataToExport, type);
                    this.downloadFile(
                        csvContent,
                        `${filename}-${new Date().toISOString().slice(0, 10)}.csv`,
                        'text/csv'
                    );
                } else if (format === 'xlsx') {
                    this.exportToExcel(dataToExport, type, filename);
                } else if (format === 'pdf') {
                    this.exportToPDF(dataToExport, type, filename);
                }
                
                this.addActivity(`Dados exportados: ${type} (${format})`, 'fa-download', 'primary');
            }

            filterByPeriod(data, period) {
                if (period === 'all') return data;
                
                const days = parseInt(period);
                if (isNaN(days)) return data;
                
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                return data.filter(item => new Date(item.datetime || item.createdAt) >= cutoffDate);
            }

            exportToExcel(data, type, filename) {
                if (!window.XLSX) {
                    this.addNotification('Erro', 'Biblioteca Excel não carregada', 'error');
                    return;
                }

                const workbook = XLSX.utils.book_new();
                
                if (type === 'vehicles' && data.vehicles) {
                    const ws = XLSX.utils.json_to_sheet(data.vehicles);
                    XLSX.utils.book_append_sheet(workbook, ws, 'Veículos');
                } else if (type === 'drivers' && data.drivers) {
                    const ws = XLSX.utils.json_to_sheet(data.drivers);
                    XLSX.utils.book_append_sheet(workbook, ws, 'Motoristas');
                } else if (type === 'speed' && data.speedRecords) {
                    const ws = XLSX.utils.json_to_sheet(data.speedRecords);
                    XLSX.utils.book_append_sheet(workbook, ws, 'Velocidade');
                } else {
                    // Multiple sheets for complete export
                    if (data.vehicles) {
                        const ws = XLSX.utils.json_to_sheet(data.vehicles);
                        XLSX.utils.book_append_sheet(workbook, ws, 'Veículos');
                    }
                    if (data.drivers) {
                        const ws = XLSX.utils.json_to_sheet(data.drivers);
                        XLSX.utils.book_append_sheet(workbook, ws, 'Motoristas');
                    }
                    if (data.speedRecords) {
                        const ws = XLSX.utils.json_to_sheet(data.speedRecords);
                        XLSX.utils.book_append_sheet(workbook, ws, 'Velocidade');
                    }
                }
                
                XLSX.writeFile(workbook, `${filename}-${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.addNotification('Sucesso', 'Arquivo Excel exportado com sucesso!', 'success');
            }

            convertToCSV(data, type) {
                let csvContent = '';
                
                if (type === 'vehicles' && data.vehicles) {
                    csvContent = 'Frota,Placa,Modelo,Turno A,Turno B,Turno C,Vencimento Tacógrafo,Data Inspeção,Status,Ano,Cor\n';
                    data.vehicles.forEach(vehicle => {
                        csvContent += `"${vehicle.fleetNumber || ''}","${vehicle.plate}","${vehicle.model}","${vehicle.driverShiftA || ''}","${vehicle.driverShiftB || ''}","${vehicle.driverShiftC || ''}","${vehicle.tachographExpiry}","${vehicle.inspectionDate}","${vehicle.status}","${vehicle.year || ''}","${vehicle.color || ''}"\n`;
                    });
                } else if (type === 'drivers' && data.drivers) {
                    csvContent = 'Nome,CNH,Categoria,Vencimento CNH,Status,Telefone,Email\n';
                    data.drivers.forEach(driver => {
                        csvContent += `"${driver.name}","${driver.license}","${driver.category}","${driver.licenseExpiry}","${driver.status}","${driver.phone || ''}","${driver.email || ''}"\n`;
                    });
                } else if (type === 'speed' && data.speedRecords) {
                    csvContent = 'Data/Hora,Veículo,Turno,Motorista,Velocidade,Limite,Localização,Status,Observações\n';
                    data.speedRecords.forEach(record => {
                        csvContent += `"${record.datetime}","${record.vehiclePlate}","${record.shift}","${record.driverName}","${record.speed}","${record.speedLimit}","${record.location}","${record.status}","${record.observations || ''}"\n`;
                    });
                }
                
                return csvContent;
            }

            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            importData(data, overwrite = false) {
                let importCount = 0;

                if (data.vehicles) {
                    data.vehicles.forEach(vehicle => {
                        const existing = this.data.vehicles.find(v => v.plate === vehicle.plate);
                        if (!existing || overwrite) {
                            if (existing && overwrite) {
                                // Update existing
                                Object.assign(existing, vehicle);
                            } else {
                                // Add new
                                vehicle.id = Math.max(...this.data.vehicles.map(v => v.id), 0) + 1;
                                this.data.vehicles.push(vehicle);
                            }
                            importCount++;
                        }
                    });
                }
                
                if (data.drivers) {
                    data.drivers.forEach(driver => {
                        const existing = this.data.drivers.find(d => d.license === driver.license);
                        if (!existing || overwrite) {
                            if (existing && overwrite) {
                                // Update existing
                                Object.assign(existing, driver);
                            } else {
                                // Add new
                                driver.id = Math.max(...this.data.drivers.map(d => d.id), 0) + 1;
                                this.data.drivers.push(driver);
                            }
                            importCount++;
                        }
                    });
                }
                
                if (data.speedRecords) {
                    data.speedRecords.forEach(record => {
                        record.id = Math.max(...this.data.speedRecords.map(r => r.id), 0) + 1;
                        this.data.speedRecords.push(record);
                        importCount++;
                    });
                }
                
                this.addActivity(`Dados importados: ${importCount} registros`, 'fa-upload', 'info');
                this.autoSave();
                return importCount;
            }

            // ========================================
            // ENHANCED GENERATE REPORT DATA
            // ========================================

            generateReportData(period, type, vehicleId = null) {
                const { expiringSoon, expired } = this.calculateExpirations();
                
                const reportData = {
                    summary: {
                        totalVehicles: this.data.vehicles.length,
                        totalDrivers: this.data.drivers.length,
                        expiringSoon: expiringSoon,
                        expired: expired
                    },
                    fleetStatus: {
                        vehiclesOk: this.data.vehicles.filter(v => v.status === 'Em dia').length,
                        activeDrivers: this.data.drivers.filter(d => d.status === 'Ativo').length,
                        complianceRate: this.data.vehicles.length > 0 ? 
                            Math.round(((this.data.vehicles.length - expiringSoon - expired) / this.data.vehicles.length) * 100) : 100
                    },
                    speedStats: {
                        normal: this.data.speedRecords.filter(r => r.status === 'Normal').length,
                        violations: this.data.speedRecords.filter(r => r.status === 'Infração').length,
                        serious: this.data.speedRecords.filter(r => r.status === 'Infração Grave').length
                    },
                    urgentAlerts: this.getUrgentAlerts()
                };
                
                return reportData;
            }

            calculateExpirations() {
                const today = new Date();
                const alertDays = this.settings.alertDays;
                const alertDate = new Date(today.getTime() + (alertDays * 24 * 60 * 60 * 1000));
                
                let expiringSoon = 0;
                let expired = 0;
                
                // Check vehicles
                this.data.vehicles.forEach(vehicle => {
                    const tachographDate = new Date(vehicle.tachographExpiry);
                    const inspectionDate = new Date(vehicle.inspectionDate);
                    const inspectionExpiry = new Date(inspectionDate.getTime() + (2 * 365 * 24 * 60 * 60 * 1000));
                    
                    if (tachographDate < today || inspectionExpiry < today) {
                        expired++;
                    } else if (tachographDate < alertDate || inspectionExpiry < alertDate) {
                        expiringSoon++;
                    }
                });
                
                // Check drivers
                this.data.drivers.forEach(driver => {
                    const licenseDate = new Date(driver.licenseExpiry);
                    if (licenseDate < today) {
                        expired++;
                    } else if (licenseDate < alertDate) {
                        expiringSoon++;
                    }
                });
                
                return { expiringSoon, expired };
            }

            getUrgentAlerts() {
                const alerts = [];
                const today = new Date();
                
                // Document expiration alerts
                this.data.vehicles.forEach(vehicle => {
                    const tachographDate = new Date(vehicle.tachographExpiry);
                    
                    if (tachographDate < today) {
                        alerts.push({
                            type: 'error',
                            message: `Tacógrafo do veículo ${vehicle.plate} (Frota ${vehicle.fleetNumber}) está vencido`
                        });
                    }
                });

                // Driver license alerts
                this.data.drivers.forEach(driver => {
                    const licenseDate = new Date(driver.licenseExpiry);
                    if (licenseDate < today) {
                        alerts.push({
                            type: 'error',
                            message: `CNH de ${driver.name} está vencida`
                        });
                    }
                });

                return alerts.slice(0, 5); // Return top 5 urgent alerts
            }

            // ========================================
            // ENHANCED DEBOUNCE FUNCTIONS
            // ========================================

            debounce(func, wait, key) {
                clearTimeout(this.debounceTimers[key]);
                this.debounceTimers[key] = setTimeout(func, wait);
            }

            // ========================================
            // SYSTEM INFO FUNCTIONS
            // ========================================

            populateSystemInfo() {
                // Populate browser info
                const browserInfo = this.getBrowserInfo();
                const screenRes = `${screen.width}x${screen.height}`;
                
                setTimeout(() => {
                    setElementText('browserInfo', browserInfo);
                    setElementText('screenResolution', screenRes);
                    setElementText('lastSystemUpdate', new Date().toLocaleString('pt-BR'));
                }, 100);
            }

            getBrowserInfo() {
                const ua = navigator.userAgent;
                if (ua.includes('Chrome')) return 'Chrome';
                if (ua.includes('Firefox')) return 'Firefox';
                if (ua.includes('Safari')) return 'Safari';
                if (ua.includes('Edge')) return 'Edge';
                return 'Desconhecido';
            }
        }

        // Initialize the enhanced application with persistence
        const app = new FleetControlAppV3();

        // Global functions for CRUD operations (FIXED AND CORRECTED)
        window.editVehicle = function(id) {
            const vehicle = app.data.vehicles.find(v => v.id === id);
            if (vehicle) {
                showEditVehicleModal(vehicle);
            }
        };

        window.viewVehicleDetails = function(id) {
            const vehicle = app.data.vehicles.find(v => v.id === id);
            if (vehicle) {
                const age = vehicle.year ? new Date().getFullYear() - vehicle.year : 'N/A';
                const driverA = getDriverNameById(vehicle.driverShiftA);
                const driverB = getDriverNameById(vehicle.driverShiftB);
                const driverC = getDriverNameById(vehicle.driverShiftC);
                
                const details = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Número da Frota:</strong> ${vehicle.fleetNumber || 'Não informado'}</div>
                            <div><strong>Placa:</strong> ${vehicle.plate}</div>
                            <div><strong>Modelo:</strong> ${vehicle.model}</div>
                            <div><strong>Ano:</strong> ${vehicle.year || 'Não informado'}</div>
                            <div><strong>Idade:</strong> ${age} anos</div>
                            <div><strong>Cor:</strong> ${vehicle.color || 'Não informada'}</div>
                        </div>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <div>
                            <h4 class="font-semibold mb-2">Motoristas por Turno:</h4>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <span class="bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-200 px-2 py-1 rounded text-xs mr-2">Turno A</span>
                                    <span>${driverA || 'Não atribuído'}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-200 px-2 py-1 rounded text-xs mr-2">Turno B</span>
                                    <span>${driverB || 'Não atribuído'}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-200 px-2 py-1 rounded text-xs mr-2">Turno C</span>
                                    <span>${driverC || 'Não atribuído'}</span>
                                </div>
                            </div>
                        </div>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Vencimento Tacógrafo:</strong> ${new Date(vehicle.tachographExpiry).toLocaleDateString('pt-BR')}</div>
                            <div><strong>Última Inspeção:</strong> ${new Date(vehicle.inspectionDate).toLocaleDateString('pt-BR')}</div>
                            <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusClass(vehicle.status)}">${vehicle.status}</span></div>
                            <div><strong>Criado em:</strong> ${new Date(vehicle.createdAt || Date.now()).toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>
                `;
                
                showConfirmDialog(`Detalhes do Veículo ${vehicle.plate}`, () => {}, details, false);
            }
        };

        window.deleteVehicle = function(id) {
            const vehicle = app.data.vehicles.find(v => v.id === id);
            if (vehicle) {
                showConfirmDialog(`Tem certeza que deseja excluir o veículo ${vehicle.plate}?`, () => {
                    app.removeVehicle(id);
                    updateVehiclesTable();
                    updateVehicleStatistics();
                    updateDashboard();
                    showToast('Veículo excluído', `Veículo ${vehicle.plate} foi excluído com sucesso`, 'warning');
                });
            }
        };

        window.editDriver = function(id) {
            const driver = app.data.drivers.find(d => d.id === id);
            if (driver) {
                showEditDriverModal(driver);
            }
        };

        window.viewDriverDetails = function(id) {
            const driver = app.data.drivers.find(d => d.id === id);
            if (driver) {
                const assignedVehicles = getVehiclesAssignedToDriver(driver.id);
                const licenseStatus = calculateDriverStatus(driver.licenseExpiry);
                
                const details = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Nome:</strong> ${driver.name}</div>
                            <div><strong>CNH:</strong> ${driver.license}</div>
                            <div><strong>Categoria:</strong> ${driver.category}</div>
                            <div><strong>Vencimento CNH:</strong> ${new Date(driver.licenseExpiry).toLocaleDateString('pt-BR')}</div>
                            <div><strong>Telefone:</strong> ${driver.phone || 'Não informado'}</div>
                            <div><strong>Email:</strong> ${driver.email || 'Não informado'}</div>
                        </div>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <div>
                            <h4 class="font-semibold mb-2">Veículos Atribuídos:</h4>
                            ${assignedVehicles.length > 0 ? 
                                assignedVehicles.map(assignment => `
                                    <div class="flex items-center mb-2">
                                        <span class="bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded mr-2">${assignment.vehicle}</span>
                                        <span class="text-${assignment.shift === 'A' ? 'blue' : assignment.shift === 'B' ? 'green' : 'purple'}-600 font-medium">Turno ${assignment.shift}</span>
                                    </div>
                                `).join('') :
                                '<p class="text-gray-500 dark:text-gray-400">Nenhum veículo atribuído</p>'
                            }
                        </div>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusClass(licenseStatus)}">${licenseStatus}</span></div>
                            <div><strong>Criado em:</strong> ${new Date(driver.createdAt || Date.now()).toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>
                `;
                
                showConfirmDialog(`Detalhes do Motorista ${driver.name}`, () => {}, details, false);
            }
        };

        window.deleteDriver = function(id) {
            const driver = app.data.drivers.find(d => d.id === id);
            if (driver) {
                const assignedVehicles = getVehiclesAssignedToDriver(driver.id);
                if (assignedVehicles.length > 0) {
                    showAlert('Não é possível excluir este motorista pois ele está atribuído a veículos. Remova as atribuições primeiro.');
                    return;
                }
                
                showConfirmDialog(`Tem certeza que deseja excluir o motorista ${driver.name}?`, () => {
                    app.removeDriver(id);
                    updateDriversTable();
                    updateDriverStatistics();
                    updateDashboard();
                    populateDriverSelects();
                    showToast('Motorista excluído', `Motorista ${driver.name} foi excluído com sucesso`, 'warning');
                });
            }
        };

        window.viewSpeedDetails = function(id) {
            const record = app.data.speedRecords.find(r => r.id === id);
            if (record) {
                const overLimit = record.speed - record.speedLimit;
                const percentage = Math.round((overLimit / record.speedLimit) * 100);
                
                const details = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Data/Hora:</strong> ${new Date(record.datetime).toLocaleString('pt-BR')}</div>
                            <div><strong>Veículo:</strong> ${record.vehiclePlate} ${record.vehicleFleetNumber ? `(Frota ${record.vehicleFleetNumber})` : ''}</div>
                            <div><strong>Turno:</strong> ${record.shift}</div>
                            <div><strong>Motorista:</strong> ${record.driverName}</div>
                            <div><strong>Velocidade:</strong> ${record.speed} km/h</div>
                            <div><strong>Limite da Via:</strong> ${record.speedLimit} km/h</div>
                            <div><strong>Excesso:</strong> ${overLimit > 0 ? `+${overLimit} km/h (${percentage}%)` : 'Dentro do limite'}</div>
                            <div><strong>Localização:</strong> ${record.location}</div>
                        </div>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <div>
                            <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusClass(record.status)}">${record.status}</span></div>
                            ${record.observations ? `<div class="mt-2"><strong>Observações:</strong> ${record.observations}</div>` : ''}
                        </div>
                        <hr class="border-gray-200 dark:border-gray-600">
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            <div><strong>Registrado em:</strong> ${new Date(record.createdAt || Date.now()).toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                `;
                
                showConfirmDialog(`Detalhes do Registro de Velocidade`, () => {}, details, false);
            }
        };

        window.deleteSpeedRecord = function(id) {
            const record = app.data.speedRecords.find(r => r.id === id);
            if (record) {
                showConfirmDialog(`Tem certeza que deseja excluir este registro de velocidade?`, () => {
                    app.removeSpeedRecord(id);
                    updateSpeedHistoryTable();
                    updateSpeedTracking();
                    updateDashboard();
                    showToast('Registro excluído', 'Registro de velocidade foi excluído com sucesso', 'warning');
                });
            }
        };

        // ========================================
        // ENHANCED UI FUNCTIONS
        // ========================================

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('FleetControl Pro v3.0 inicializando com monitoramento por veículo...');
            
            try {
                showLoadingOverlay();
                
                setTimeout(() => {
                    initializeDateTime();
                    updateDashboard();
                    updateAllTables();
                    updateSpeedTracking();
                    initCharts();
                    setupEventListeners();
                    populateSelects();
                    updateDataStatistics();
                    populateYearFilters();
                    
                    // Set current datetime for forms
                    const now = new Date();
                    const currentDateTime = now.toISOString().slice(0, 16);
                    setElementValue('quickSpeedDateTime', currentDateTime);
                    setElementValue('speedDateTime', currentDateTime);
                    
                    // Set today's date
                    setElementText('todayDate', now.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
                    
                    hideLoadingOverlay();
                    
                    console.log('FleetControl Pro v3.0 inicializado com sucesso!');
                    
                }, 800);
                
            } catch (error) {
                console.error('Erro na inicialização:', error);
                hideLoadingOverlay();
                showToast('Erro', 'Falha na inicialização do sistema', 'error');
            }
        });

        // Enhanced loading overlay functions
        function showLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // Enhanced date and time display
        function initializeDateTime() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }

        function updateDateTime() {
            const now = new Date();
            const element = document.getElementById('currentDateTime');
            if (element) {
                element.textContent = now.toLocaleString('pt-BR', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }

        // Enhanced tab navigation
        function showTab(tabName) {
            try {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });
                
                // Update navigation buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active-tab', 'border-primary', 'text-primary');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Show selected tab with animation
                const targetTab = document.getElementById(tabName);
                if (targetTab) {
                    targetTab.classList.remove('hidden');
                    targetTab.style.opacity = '0';
                    targetTab.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        targetTab.style.transition = 'all 0.3s ease-in-out';
                        targetTab.style.opacity = '1';
                        targetTab.style.transform = 'translateY(0)';
                    }, 10);
                }
                
                // Update active navigation button
                if (event && event.target) {
                    event.target.classList.remove('border-transparent', 'text-gray-500');
                    event.target.classList.add('active-tab', 'border-primary', 'text-primary');
                }
                
                // Tab-specific updates
                switch (tabName) {
                    case 'dashboard':
                        updateDashboard();
                        updatePerformanceMetrics();
                        break;
                    case 'vehicles':
                        updateVehiclesTable();
                        updateVehicleStatistics();
                        break;
                    case 'drivers':
                        updateDriversTable();
                        updateDriverStatistics();
                        break;
                    case 'speed-tracking':
                        updateSpeedTracking();
                        break;
                    case 'reports':
                        populateReportSelects();
                        break;
                    case 'backup':
                        updateDataStatistics();
                        break;
                }
                
                app.addActivity(`Navegou para: ${getTabLabel(tabName)}`, 'fa-mouse-pointer', 'info');
                
            } catch (error) {
                console.error('Erro ao mudar tab:', error);
                showToast('Erro', 'Erro ao navegar entre seções', 'error');
            }
        }

        function getTabLabel(tabName) {
            const labels = {
                dashboard: 'Dashboard',
                vehicles: 'Veículos',
                drivers: 'Motoristas',
                'speed-tracking': 'Monitoramento',
                reports: 'Relatórios',
                backup: 'Backup & Dados'
            };
            return labels[tabName] || tabName;
        }

        // Enhanced dashboard update
        function updateDashboard() {
            try {
                const stats = app.getStats();
                
                // Update basic stats
                setElementText('totalVehicles', stats.totalVehicles);
                setElementText('activeDrivers', app.data.drivers.filter(d => d.status === 'Ativo').length);
                setElementText('headerVehicleCount', stats.totalVehicles);
                
                // Calculate expirations
                const { expiringSoon, expired } = app.calculateExpirations();
                setElementText('expiringSoon', expiringSoon);
                setElementText('expired', expired);
                setElementText('headerAlertCount', expiringSoon + expired);
                setElementText('alertsCount', expiringSoon + expired);
                
                // Calculate compliance rate
                const totalDocuments = stats.totalVehicles + stats.totalDrivers;
                const compliantDocuments = totalDocuments - expiringSoon - expired;
                const complianceRate = totalDocuments > 0 ? Math.round((compliantDocuments / totalDocuments) * 100) : 100;
                setElementText('headerComplianceRate', `${complianceRate}%`);
                
                updateAlertsList();
                updateRecentActivity();
                updateTodayStats();
                
            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
            }
        }

        function updatePerformanceMetrics() {
            try {
                const stats = app.getStats();
                const { expiringSoon, expired } = app.calculateExpirations();
                
                // Calculate performance metrics
                const totalDocuments = (stats.totalVehicles * 2) + stats.totalDrivers; // Each vehicle has 2 docs
                const compliantDocuments = totalDocuments - (expiringSoon * 2) - (expired * 2);
                const complianceRate = totalDocuments > 0 ? Math.round((compliantDocuments / totalDocuments) * 100) : 100;
                
                const totalVehicleDocs = stats.totalVehicles * 2;
                const compliantVehicleDocs = totalVehicleDocs - ((expiringSoon + expired) * 2);
                const docsUpToDate = totalVehicleDocs > 0 ? Math.round((compliantVehicleDocs / totalVehicleDocs) * 100) : 100;
                
                // Calculate average speed
                const recentSpeedRecords = app.data.speedRecords.slice(-10);
                const avgSpeed = recentSpeedRecords.length > 0 
                    ? Math.round(recentSpeedRecords.reduce((sum, r) => sum + r.speed, 0) / recentSpeedRecords.length)
                    : 0;
                
                const maxSpeed = 120;
                const speedPercentage = Math.round((avgSpeed / maxSpeed) * 100);
                
                // Update UI
                setElementText('complianceRate', `${complianceRate}%`);
                setElementText('docsUpToDate', `${docsUpToDate}%`);
                setElementText('fleetAvgSpeed', avgSpeed);
                setElementText('speedPercentage', `${speedPercentage}%`);
                setElementText('performanceScore', `${Math.round((complianceRate + docsUpToDate) / 2)}%`);
                setElementText('avgSpeedToday', `${avgSpeed} km/h`);
                
                // Update progress bars with animation
                setTimeout(() => {
                    const complianceBar = document.getElementById('complianceBar');
                    const docsBar = document.getElementById('docsBar');
                    
                    if (complianceBar) complianceBar.style.width = `${complianceRate}%`;
                    if (docsBar) docsBar.style.width = `${docsUpToDate}%`;
                }, 100);
                
            } catch (error) {
                console.error('Erro ao atualizar métricas de performance:', error);
            }
        }

        function updateTodayStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const todayRecords = app.data.speedRecords.filter(r => r.datetime.startsWith(today));
                const todayViolations = todayRecords.filter(r => r.status.includes('Infração'));
                const todayActiveVehicles = new Set(todayRecords.map(r => r.vehicleId)).size;
                
                setElementText('todayRecords', todayRecords.length);
                setElementText('todayViolations', todayViolations.length);
                setElementText('todayActiveVehicles', todayActiveVehicles);
                
            } catch (error) {
                console.error('Erro ao atualizar estatísticas de hoje:', error);
            }
        }

        function updateAlertsList() {
            const alertsList = document.getElementById('alertsList');
            if (!alertsList) return;
            
            const alerts = app.getUrgentAlerts();
            
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-success text-4xl mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400 font-medium">Nenhum alerta no momento</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Todos os documentos estão em dia</p>
                    </div>
                `;
            } else {
                alertsList.innerHTML = alerts.map(alert => `
                    <div class="flex items-start p-4 rounded-lg border-l-4 ${
                        alert.type === 'error' 
                            ? 'bg-red-50 dark:bg-red-900/20 border-red-500' 
                            : 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500'
                    } hover:shadow-md transition-all duration-200">
                        <i class="fas fa-exclamation-triangle ${
                            alert.type === 'error' ? 'text-red-500' : 'text-yellow-500'
                        } mr-3 mt-1"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium ${
                                alert.type === 'error' 
                                    ? 'text-red-800 dark:text-red-200' 
                                    : 'text-yellow-800 dark:text-yellow-200'
                            }">${alert.message}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateRecentActivity() {
            const recentActivity = document.getElementById('recentActivity');
            if (!recentActivity) return;
            
            const activities = app.data.recentActivities;
            
            if (activities.length === 0) {
                recentActivity.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-clock text-gray-300 dark:text-gray-600 text-4xl mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400 font-medium">Nenhuma atividade recente</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">As ações do sistema aparecerão aqui</p>
                    </div>
                `;
            } else {
                recentActivity.innerHTML = activities.slice(0, 10).map(activity => `
                    <div class="flex items-start p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 group">
                        <div class="flex-shrink-0 p-2 bg-${activity.color}/10 rounded-lg group-hover:bg-${activity.color}/20 transition-colors">
                            <i class="fas ${activity.icon} text-${activity.color}"></i>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">${activity.message}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                ${new Date(activity.datetime).toLocaleString('pt-BR')}
                            </p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function clearRecentActivity() {
            showConfirmDialog('Tem certeza que deseja limpar o histórico de atividades?', () => {
                app.data.recentActivities = [];
                app.autoSave();
                updateRecentActivity();
                showToast('Histórico Limpo', 'Histórico de atividades foi limpo', 'info');
            });
        }

        function refreshAlerts() {
            updateAlertsList();
            showToast('Atualizado', 'Lista de alertas foi atualizada', 'success');
        }

        function refreshRecentActivity() {
            updateRecentActivity();
            showToast('Atualizado', 'Atividades recentes foram atualizadas', 'success');
        }

        // ========================================
        // ENHANCED VEHICLES MANAGEMENT WITH SHIFT SUPPORT
        // ========================================

        function updateVehiclesTable() {
            const table = document.getElementById('vehiclesTable');
            if (!table) return;
            
            const search = app.filters.vehicles.search;
            const status = app.filters.vehicles.status;
            const year = app.filters.vehicles.year;
            let filteredVehicles = app.searchVehicles(search, status, year);
            
            // Apply pagination
            const pagination = app.pagination.vehicles;
            const startIndex = (pagination.currentPage - 1) * pagination.itemsPerPage;
            const endIndex = startIndex + pagination.itemsPerPage;
            const paginatedVehicles = filteredVehicles.slice(startIndex, endIndex);
            
            if (paginatedVehicles.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-truck text-4xl mb-3 opacity-50"></i>
                            <p class="font-medium">Nenhum veículo encontrado</p>
                            <p class="text-sm">Adicione veículos ou ajuste os filtros</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            table.innerHTML = paginatedVehicles.map(vehicle => {
                const statusClass = getStatusClass(vehicle.status);
                const age = vehicle.year ? new Date().getFullYear() - vehicle.year : 0;
                
                // Get driver names for each shift
                const driverA = vehicle.driverShiftA ? getDriverNameById(vehicle.driverShiftA) : '';
                const driverB = vehicle.driverShiftB ? getDriverNameById(vehicle.driverShiftB) : '';
                const driverC = vehicle.driverShiftC ? getDriverNameById(vehicle.driverShiftC) : '';
                
                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 table-enhanced">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 bg-gradient-to-br from-primary/20 to-primary/10 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-hashtag text-primary text-sm"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-900 dark:text-white">${vehicle.fleetNumber || 'N/A'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 bg-gradient-to-br from-primary/20 to-primary/10 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-truck text-primary text-sm"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">${vehicle.plate}</span>
                                    ${vehicle.year ? `<p class="text-xs text-gray-500 dark:text-gray-400">${age} anos</p>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <span class="text-sm text-gray-900 dark:text-white">${vehicle.model}</span>
                                ${vehicle.color ? `<p class="text-xs text-gray-500 dark:text-gray-400">${vehicle.color}</p>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="space-y-1">
                                <div class="flex items-center">
                                    <span class="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-200 px-2 py-1 rounded-full mr-2">A</span>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">${driverA || 'Não atribuído'}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-xs bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-200 px-2 py-1 rounded-full mr-2">B</span>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">${driverB || 'Não atribuído'}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-xs bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-200 px-2 py-1 rounded-full mr-2">C</span>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">${driverC || 'Não atribuído'}</span>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <span class="text-sm text-gray-900 dark:text-white">${new Date(vehicle.tachographExpiry).toLocaleDateString('pt-BR')}</span>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${getDaysUntilExpiry(vehicle.tachographExpiry)} dias</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${statusClass}">${vehicle.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <button onclick="viewVehicleDetails(${vehicle.id})" class="text-info hover:text-info/80 transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Ver Detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editVehicle(${vehicle.id})" class="text-primary hover:text-primary/80 transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteVehicle(${vehicle.id})" class="text-danger hover:text-danger/80 transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateVehiclesPagination(filteredVehicles.length);
        }

        function updateVehicleStatistics() {
            const vehicles = app.data.vehicles;
            const total = vehicles.length;
            const active = vehicles.filter(v => v.status === 'Em dia').length;
            const alerts = vehicles.filter(v => v.status === 'A vencer' || v.status === 'Vencido').length;
            const avgAge = total > 0 ? Math.round(vehicles.reduce((sum, v) => sum + (v.year ? new Date().getFullYear() - v.year : 0), 0) / total) : 0;
            
            setElementText('vehicleStatsTotal', total);
            setElementText('vehicleStatsActive', active);
            setElementText('vehicleStatsAlerts', alerts);
            setElementText('vehicleStatsAvgAge', `${avgAge} anos`);
        }

        function updateVehiclesPagination(totalItems) {
            const pagination = app.pagination.vehicles;
            const totalPages = Math.ceil(totalItems / pagination.itemsPerPage);
            const startItem = (pagination.currentPage - 1) * pagination.itemsPerPage + 1;
            const endItem = Math.min(pagination.currentPage * pagination.itemsPerPage, totalItems);
            
            setElementText('vehiclesShowingStart', startItem);
            setElementText('vehiclesShowingEnd', endItem);
            setElementText('vehiclesTotal', totalItems);
            
            // Update pagination buttons
            const prevBtn = document.getElementById('vehiclesPrevBtn');
            const nextBtn = document.getElementById('vehiclesNextBtn');
            const prevBtnMobile = document.getElementById('vehiclesPrevBtnMobile');
            const nextBtnMobile = document.getElementById('vehiclesNextBtnMobile');
            
            if (prevBtn) prevBtn.disabled = pagination.currentPage <= 1;
            if (nextBtn) nextBtn.disabled = pagination.currentPage >= totalPages;
            if (prevBtnMobile) prevBtnMobile.disabled = pagination.currentPage <= 1;
            if (nextBtnMobile) nextBtnMobile.disabled = pagination.currentPage >= totalPages;
        }

        function previousVehiclesPage() {
            if (app.pagination.vehicles.currentPage > 1) {
                app.pagination.vehicles.currentPage--;
                updateVehiclesTable();
            }
        }

        function nextVehiclesPage() {
            const totalItems = app.searchVehicles(app.filters.vehicles.search, app.filters.vehicles.status, app.filters.vehicles.year).length;
            const totalPages = Math.ceil(totalItems / app.pagination.vehicles.itemsPerPage);
            
            if (app.pagination.vehicles.currentPage < totalPages) {
                app.pagination.vehicles.currentPage++;
                updateVehiclesTable();
            }
        }

        function filterVehicles() {
            app.filters.vehicles.status = getValue('vehicleStatusFilter');
            app.filters.vehicles.year = getValue('vehicleYearFilter');
            app.pagination.vehicles.currentPage = 1;
            updateVehiclesTable();
        }

        function debouncedVehicleSearch() {
            const searchValue = getValue('vehicleSearch');
            app.debounce(() => {
                app.filters.vehicles.search = searchValue;
                app.pagination.vehicles.currentPage = 1;
                updateVehiclesTable();
            }, 300, 'vehicleSearch');
        }

        function sortVehicles(field) {
            const sorting = app.sorting.vehicles;
            
            if (sorting.field === field) {
                sorting.direction = sorting.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sorting.field = field;
                sorting.direction = 'asc';
            }
            
            updateVehiclesTable();
        }

        // ========================================
        // ENHANCED DRIVERS MANAGEMENT
        // ========================================

        function updateDriversTable() {
            const table = document.getElementById('driversTable');
            if (!table) return;
            
            const search = app.filters.drivers.search;
            const category = app.filters.drivers.category;
            const status = app.filters.drivers.status;
            let filteredDrivers = app.searchDrivers(search, category, status);
            
            // Apply pagination
            const pagination = app.pagination.drivers;
            const startIndex = (pagination.currentPage - 1) * pagination.itemsPerPage;
            const endIndex = startIndex + pagination.itemsPerPage;
            const paginatedDrivers = filteredDrivers.slice(startIndex, endIndex);
            
            if (paginatedDrivers.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-users text-4xl mb-3 opacity-50"></i>
                            <p class="font-medium">Nenhum motorista encontrado</p>
                            <p class="text-sm">Adicione motoristas ou ajuste os filtros</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            table.innerHTML = paginatedDrivers.map(driver => {
                const licenseStatus = calculateDriverStatus(driver.licenseExpiry);
                const statusClass = getStatusClass(licenseStatus);
                const assignedVehicles = getVehiclesAssignedToDriver(driver.id);
                
                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 table-enhanced">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 bg-gradient-to-br from-info/20 to-info/10 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-info text-sm"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-900 dark:text-white">${driver.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-900 dark:text-white font-mono">${driver.license}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">${driver.category}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <span class="text-sm text-gray-900 dark:text-white">${new Date(driver.licenseExpiry).toLocaleDateString('pt-BR')}</span>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${getDaysUntilExpiry(driver.licenseExpiry)} dias</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="space-y-1">
                                ${assignedVehicles.length > 0 ? 
                                    assignedVehicles.map(assignment => `
                                        <div class="flex items-center">
                                            <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded mr-2">${assignment.vehicle}</span>
                                            <span class="text-xs text-${assignment.shift === 'A' ? 'blue' : assignment.shift === 'B' ? 'green' : 'purple'}-600 font-medium">Turno ${assignment.shift}</span>
                                        </div>
                                    `).join('') :
                                    '<span class="text-xs text-gray-500 dark:text-gray-400">Nenhum veículo</span>'
                                }
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${statusClass}">${licenseStatus}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <button onclick="viewDriverDetails(${driver.id})" class="text-info hover:text-info/80 transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Ver Detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editDriver(${driver.id})" class="text-primary hover:text-primary/80 transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteDriver(${driver.id})" class="text-danger hover:text-danger/80 transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateDriversPagination(filteredDrivers.length);
        }

        function updateDriverStatistics() {
            const drivers = app.data.drivers;
            const total = drivers.length;
            const active = drivers.filter(d => d.status === 'Ativo').length;
            const expiring = drivers.filter(d => calculateDriverStatus(d.licenseExpiry) === 'A vencer').length;
            const expired = drivers.filter(d => calculateDriverStatus(d.licenseExpiry) === 'CNH Vencida').length;
            
            setElementText('driverStatsTotal', total);
            setElementText('driverStatsActive', active);
            setElementText('driverStatsExpiring', expiring);
            setElementText('driverStatsExpired', expired);
        }

        function updateDriversPagination(totalItems) {
            const pagination = app.pagination.drivers;
            const totalPages = Math.ceil(totalItems / pagination.itemsPerPage);
            const startItem = (pagination.currentPage - 1) * pagination.itemsPerPage + 1;
            const endItem = Math.min(pagination.currentPage * pagination.itemsPerPage, totalItems);
            
            setElementText('driversShowingStart', startItem);
            setElementText('driversShowingEnd', endItem);
            setElementText('driversTotal', totalItems);
            
            // Update pagination buttons
            const prevBtn = document.getElementById('driversPrevBtn');
            const nextBtn = document.getElementById('driversNextBtn');
            const prevBtnMobile = document.getElementById('driversPrevBtnMobile');
            const nextBtnMobile = document.getElementById('driversNextBtnMobile');
            
            if (prevBtn) prevBtn.disabled = pagination.currentPage <= 1;
            if (nextBtn) nextBtn.disabled = pagination.currentPage >= totalPages;
            if (prevBtnMobile) prevBtnMobile.disabled = pagination.currentPage <= 1;
            if (nextBtnMobile) nextBtnMobile.disabled = pagination.currentPage >= totalPages;
        }

        function previousDriversPage() {
            if (app.pagination.drivers.currentPage > 1) {
                app.pagination.drivers.currentPage--;
                updateDriversTable();
            }
        }

        function nextDriversPage() {
            const totalItems = app.searchDrivers(app.filters.drivers.search, app.filters.drivers.category, app.filters.drivers.status).length;
            const totalPages = Math.ceil(totalItems / app.pagination.drivers.itemsPerPage);
            
            if (app.pagination.drivers.currentPage < totalPages) {
                app.pagination.drivers.currentPage++;
                updateDriversTable();
            }
        }

        function filterDrivers() {
            app.filters.drivers.category = getValue('driverCategoryFilter');
            app.filters.drivers.status = getValue('driverStatusFilter');
            app.pagination.drivers.currentPage = 1;
            updateDriversTable();
        }

        function debouncedDriverSearch() {
            const searchValue = getValue('driverSearch');
            app.debounce(() => {
                app.filters.drivers.search = searchValue;
                app.pagination.drivers.currentPage = 1;
                updateDriversTable();
            }, 300, 'driverSearch');
        }

        function sortDrivers(field) {
            const sorting = app.sorting.drivers;
            
            if (sorting.field === field) {
                sorting.direction = sorting.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sorting.field = field;
                sorting.direction = 'asc';
            }
            
            updateDriversTable();
        }

        // ========================================
        // ENHANCED SPEED TRACKING WITH VEHICLE-BASED MONITORING
        // ========================================

        function updateSpeedTracking() {
            updateSpeedHistoryTable();
            updateSpeedStatus();
            updateSpeedAlerts();
            populateSpeedHistoryFilters();
        }

        function updateSpeedHistoryTable() {
            const table = document.getElementById('speedHistoryTable');
            if (!table) return;
            
            const filters = {
                date: getValue('speedHistoryDate'),
                vehicle: getValue('speedHistoryVehicle'),
                status: getValue('speedHistoryStatus')
            };
            
            let filteredRecords = app.searchSpeedRecords(filters);
            
            // Apply pagination
            const pagination = app.pagination.speedRecords;
            const startIndex = (pagination.currentPage - 1) * pagination.itemsPerPage;
            const endIndex = startIndex + pagination.itemsPerPage;
            const paginatedRecords = filteredRecords.slice(startIndex, endIndex);
            
            if (paginatedRecords.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-tachometer-alt text-4xl mb-3 opacity-50"></i>
                            <p class="font-medium">Nenhum registro de velocidade encontrado</p>
                            <p class="text-sm">Adicione registros ou ajuste os filtros</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            table.innerHTML = paginatedRecords.map(record => {
                const statusClass = getStatusClass(record.status);
                const overLimit = record.speed - record.speedLimit;
                
                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 table-enhanced">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <span class="text-sm text-gray-900 dark:text-white">${new Date(record.datetime).toLocaleDateString('pt-BR')}</span>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(record.datetime).toLocaleTimeString('pt-BR')}</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8 bg-gradient-to-br from-primary/20 to-primary/10 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-truck text-primary text-sm"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">${record.vehiclePlate}</span>
                                    ${record.vehicleFleetNumber ? `<p class="text-xs text-gray-500 dark:text-gray-400">Frota ${record.vehicleFleetNumber}</p>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-xs bg-${record.shift === 'A' ? 'blue' : record.shift === 'B' ? 'green' : 'purple'}-100 text-${record.shift === 'A' ? 'blue' : record.shift === 'B' ? 'green' : 'purple'}-800 dark:bg-${record.shift === 'A' ? 'blue' : record.shift === 'B' ? 'green' : 'purple'}-900/20 dark:text-${record.shift === 'A' ? 'blue' : record.shift === 'B' ? 'green' : 'purple'}-200 px-2 py-1 rounded-full">
                                Turno ${record.shift}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-900 dark:text-white">${record.driverName}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="text-sm font-bold ${overLimit > 0 ? 'text-red-600' : 'text-green-600'}">${record.speed}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-1">km/h</span>
                                ${overLimit > 0 ? `<span class="text-xs text-red-500 ml-2">+${overLimit}</span>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-900 dark:text-white">${record.speedLimit} km/h</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap max-w-xs">
                            <span class="text-sm text-gray-900 dark:text-white truncate" title="${record.location}">${record.location}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${statusClass}">${record.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <button onclick="viewSpeedDetails(${record.id})" class="text-info hover:text-info/80 transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Ver Detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="deleteSpeedRecord(${record.id})" class="text-danger hover:text-danger/80 transition-colors p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateSpeedPagination(filteredRecords.length);
        }

        function updateSpeedStatus() {
            const container = document.getElementById('currentSpeedStatus');
            if (!container) return;
            
            const recentRecords = app.data.speedRecords.slice(-10);
            const vehicleStatus = new Map();
            
            // Group by vehicle
            recentRecords.forEach(record => {
                if (!vehicleStatus.has(record.vehicleId)) {
                    vehicleStatus.set(record.vehicleId, {
                        vehiclePlate: record.vehiclePlate,
                        vehicleFleetNumber: record.vehicleFleetNumber,
                        lastRecord: record,
                        violations: 0
                    });
                }
                
                const status = vehicleStatus.get(record.vehicleId);
                if (record.status.includes('Infração')) {
                    status.violations++;
                }
                
                // Update if this record is more recent
                if (new Date(record.datetime) > new Date(status.lastRecord.datetime)) {
                    status.lastRecord = record;
                }
            });
            
            if (vehicleStatus.size === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-8">
                        <i class="fas fa-tachometer-alt text-gray-300 dark:text-gray-600 text-4xl mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400 font-medium">Nenhum registro recente</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Registre velocidades para ver o status</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = Array.from(vehicleStatus.values()).map(status => {
                const lastRecord = status.lastRecord;
                const isViolation = lastRecord.status.includes('Infração');
                
                return `
                    <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-600 p-4 rounded-lg border ${isViolation ? 'border-red-200 dark:border-red-800' : 'border-gray-200 dark:border-gray-600'} hover:shadow-md transition-all duration-200">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="h-8 w-8 bg-gradient-to-br from-primary/20 to-primary/10 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-truck text-primary text-sm"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">${status.vehiclePlate}</span>
                                    ${status.vehicleFleetNumber ? `<p class="text-xs text-gray-500 dark:text-gray-400">Frota ${status.vehicleFleetNumber}</p>` : ''}
                                </div>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full ${isViolation ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-200' : 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-200'}">
                                ${lastRecord.status}
                            </span>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Última velocidade:</span>
                                <span class="font-medium ${isViolation ? 'text-red-600' : 'text-green-600'}">${lastRecord.speed} km/h</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Turno/Motorista:</span>
                                <span class="font-medium text-gray-900 dark:text-white">${lastRecord.shift} - ${lastRecord.driverName}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Última atualização:</span>
                                <span class="text-gray-500 dark:text-gray-400">${new Date(lastRecord.datetime).toLocaleString('pt-BR')}</span>
                            </div>
                            ${status.violations > 0 ? `
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Infrações recentes:</span>
                                    <span class="font-medium text-red-600">${status.violations}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSpeedAlerts() {
            const container = document.getElementById('speedAlerts');
            const countElement = document.getElementById('speedAlertsCount');
            if (!container) return;
            
            const violations = app.data.speedRecords.filter(r => r.status.includes('Infração')).slice(-10);
            
            if (countElement) {
                countElement.textContent = violations.length;
            }
            
            if (violations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-success text-4xl mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400 font-medium">Nenhuma infração recente</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Frota dentro dos limites</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = violations.map(violation => {
                const overLimit = violation.speed - violation.speedLimit;
                const isGrave = violation.status.includes('Grave');
                
                return `
                    <div class="flex items-start p-3 rounded-lg border-l-4 ${isGrave ? 'bg-red-50 dark:bg-red-900/20 border-red-500' : 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500'} hover:shadow-md transition-all duration-200">
                        <i class="fas fa-exclamation-triangle ${isGrave ? 'text-red-500' : 'text-yellow-500'} mr-3 mt-1"></i>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-medium ${isGrave ? 'text-red-800 dark:text-red-200' : 'text-yellow-800 dark:text-yellow-200'}">
                                        ${violation.vehiclePlate} - Turno ${violation.shift}
                                    </p>
                                    <p class="text-xs ${isGrave ? 'text-red-600 dark:text-red-300' : 'text-yellow-600 dark:text-yellow-300'} mt-1">
                                        ${violation.speed}km/h (limite ${violation.speedLimit}km/h) - Excesso: +${overLimit}km/h
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                        ${violation.location} • ${new Date(violation.datetime).toLocaleString('pt-BR')}
                                    </p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${isGrave ? 'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-200' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200'}">
                                    ${violation.status}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSpeedPagination(totalItems) {
            const pagination = app.pagination.speedRecords;
            const totalPages = Math.ceil(totalItems / pagination.itemsPerPage);
            const startItem = (pagination.currentPage - 1) * pagination.itemsPerPage + 1;
            const endItem = Math.min(pagination.currentPage * pagination.itemsPerPage, totalItems);
            
            setElementText('speedShowingStart', startItem);
            setElementText('speedShowingEnd', endItem);
            setElementText('speedTotal', totalItems);
            
            // Update pagination buttons
            const prevBtn = document.getElementById('speedPrevBtn');
            const nextBtn = document.getElementById('speedNextBtn');
            const prevBtnMobile = document.getElementById('speedPrevBtnMobile');
            const nextBtnMobile = document.getElementById('speedNextBtnMobile');
            
            if (prevBtn) prevBtn.disabled = pagination.currentPage <= 1;
            if (nextBtn) nextBtn.disabled = pagination.currentPage >= totalPages;
            if (prevBtnMobile) prevBtnMobile.disabled = pagination.currentPage <= 1;
            if (nextBtnMobile) nextBtnMobile.disabled = pagination.currentPage >= totalPages;
        }

        function previousSpeedPage() {
            if (app.pagination.speedRecords.currentPage > 1) {
                app.pagination.speedRecords.currentPage--;
                updateSpeedHistoryTable();
            }
        }

        function nextSpeedPage() {
            const filters = {
                date: getValue('speedHistoryDate'),
                vehicle: getValue('speedHistoryVehicle'),
                status: getValue('speedHistoryStatus')
            };
            const totalItems = app.searchSpeedRecords(filters).length;
            const totalPages = Math.ceil(totalItems / app.pagination.speedRecords.itemsPerPage);
            
            if (app.pagination.speedRecords.currentPage < totalPages) {
                app.pagination.speedRecords.currentPage++;
                updateSpeedHistoryTable();
            }
        }

        function filterSpeedHistory() {
            app.pagination.speedRecords.currentPage = 1;
            updateSpeedHistoryTable();
        }

        function sortSpeedRecords(field) {
            const sorting = app.sorting.speedRecords;
            
            if (sorting.field === field) {
                sorting.direction = sorting.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sorting.field = field;
                sorting.direction = 'asc';
            }
            
            updateSpeedHistoryTable();
        }

        function refreshSpeedStatus() {
            updateSpeedStatus();
            showToast('Atualizado', 'Status de velocidade atualizado', 'success');
        }

        function refreshSpeedAlerts() {
            updateSpeedAlerts();
            showToast('Atualizado', 'Alertas de velocidade atualizados', 'success');
        }

        function exportSpeedData() {
            app.exportData('speed', 'xlsx', '30');
            showToast('Exportado', 'Dados de velocidade exportados para Excel', 'success');
        }

        // ========================================
        // ENHANCED MODAL FUNCTIONS
        // ========================================

        function showAddVehicleModal() {
            populateDriverSelects();
            
            // Set default dates
            const now = new Date();
            const oneYearLater = new Date(now.getFullYear() + 1, now.getMonth(), now.getDate());
            
            setElementValue('vehicleTachograph', oneYearLater.toISOString().split('T')[0]);
            setElementValue('vehicleInspection', now.toISOString().split('T')[0]);
            
            showModal('addVehicleModal');
        }

        function closeAddVehicleModal() {
            hideModal('addVehicleModal');
            document.getElementById('addVehicleForm').reset();
        }

        function showEditVehicleModal(vehicle) {
            populateDriverSelects();
            
            // Populate form with vehicle data
            setElementValue('editVehicleId', vehicle.id);
            setElementValue('editVehicleFleetNumber', vehicle.fleetNumber);
            setElementValue('editVehiclePlate', vehicle.plate);
            setElementValue('editVehicleModel', vehicle.model);
            setElementValue('editVehicleYear', vehicle.year || '');
            setElementValue('editVehicleColor', vehicle.color || '');
            setElementValue('editVehicleDriverA', vehicle.driverShiftA || '');
            setElementValue('editVehicleDriverB', vehicle.driverShiftB || '');
            setElementValue('editVehicleDriverC', vehicle.driverShiftC || '');
            setElementValue('editVehicleTachograph', vehicle.tachographExpiry);
            setElementValue('editVehicleInspection', vehicle.inspectionDate);
            
            // Populate driver selects for edit modal
            populateSelectOptions('editVehicleDriverA', app.data.drivers, 'id', 'name');
            populateSelectOptions('editVehicleDriverB', app.data.drivers, 'id', 'name');
            populateSelectOptions('editVehicleDriverC', app.data.drivers, 'id', 'name');
            
            showModal('editVehicleModal');
        }

        function closeEditVehicleModal() {
            hideModal('editVehicleModal');
            document.getElementById('editVehicleForm').reset();
        }

        function showAddDriverModal() {
            // Set default license expiry (5 years from now)
            const fiveYearsLater = new Date();
            fiveYearsLater.setFullYear(fiveYearsLater.getFullYear() + 5);
            setElementValue('driverLicenseExpiry', fiveYearsLater.toISOString().split('T')[0]);
            
            showModal('addDriverModal');
        }

        function closeAddDriverModal() {
            hideModal('addDriverModal');
            document.getElementById('addDriverForm').reset();
        }

        function showEditDriverModal(driver) {
            // Populate form with driver data
            setElementValue('editDriverId', driver.id);
            setElementValue('editDriverName', driver.name);
            setElementValue('editDriverLicense', driver.license);
            setElementValue('editDriverCategory', driver.category);
            setElementValue('editDriverBirthDate', driver.birthDate || '');
            setElementValue('editDriverLicenseExpiry', driver.licenseExpiry);
            setElementValue('editDriverPhone', driver.phone || '');
            setElementValue('editDriverEmail', driver.email || '');
            
            showModal('editDriverModal');
        }

        function closeEditDriverModal() {
            hideModal('editDriverModal');
            document.getElementById('editDriverForm').reset();
        }

        function showSpeedEntryModal() {
            populateVehicleSelects();
            
            // Set current datetime
            const now = new Date();
            const currentDateTime = now.toISOString().slice(0, 16);
            setElementValue('quickSpeedDateTime', currentDateTime);
            
            showModal('speedEntryModal');
        }

        function closeSpeedEntryModal() {
            hideModal('speedEntryModal');
            document.getElementById('quickSpeedForm').reset();
            clearDriverInfo();
        }

        function showImportModal() {
            showModal('importModal');
        }

        function closeImportModal() {
            hideModal('importModal');
            document.getElementById('modalImportFile').value = '';
        }

        function showSettingsModal() {
            loadSettingsToModal();
            showModal('settingsModal');
        }

        function closeSettingsModal() {
            hideModal('settingsModal');
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            const modalContent = modal.querySelector('[id$="ModalContent"]');
            
            if (modal && modalContent) {
                modal.classList.remove('hidden');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
                
                // Animate in
                setTimeout(() => {
                    modalContent.style.transform = 'scale(1)';
                    modalContent.style.opacity = '1';
                }, 10);
                
                // Focus first input
                const firstInput = modalContent.querySelector('input, select, textarea');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            const modalContent = modal.querySelector('[id$="ModalContent"]');
            
            if (modal && modalContent) {
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        // ========================================
        // ENHANCED FORM SUBMISSION FUNCTIONS
        // ========================================

        function setupEventListeners() {
            // Vehicle form submission
            const addVehicleForm = document.getElementById('addVehicleForm');
            if (addVehicleForm) {
                addVehicleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleAddVehicle();
                });
            }

            const editVehicleForm = document.getElementById('editVehicleForm');
            if (editVehicleForm) {
                editVehicleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleEditVehicle();
                });
            }

            // Driver form submission
            const addDriverForm = document.getElementById('addDriverForm');
            if (addDriverForm) {
                addDriverForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleAddDriver();
                });
            }

            const editDriverForm = document.getElementById('editDriverForm');
            if (editDriverForm) {
                editDriverForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleEditDriver();
                });
            }

            // Speed form submission
            const speedEntryForm = document.getElementById('speedEntryForm');
            if (speedEntryForm) {
                speedEntryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleSpeedEntry();
                });
            }

            const quickSpeedForm = document.getElementById('quickSpeedForm');
            if (quickSpeedForm) {
                quickSpeedForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleQuickSpeedEntry();
                });
            }

            // Close modals on outside click
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('fixed') && e.target.classList.contains('inset-0')) {
                    const openModal = document.querySelector('.fixed.inset-0:not(.hidden)');
                    if (openModal) {
                        const modalId = openModal.id;
                        hideModal(modalId);
                    }
                }
            });

            // Enhanced keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.fixed.inset-0:not(.hidden)');
                    if (openModal) {
                        hideModal(openModal.id);
                    }
                }
            });
        }

        function handleAddVehicle() {
            try {
                const vehicleData = {
                    fleetNumber: getValue('vehicleFleetNumber').trim(),
                    plate: getValue('vehiclePlate').trim().toUpperCase(),
                    model: getValue('vehicleModel').trim(),
                    year: getValue('vehicleYear') ? parseInt(getValue('vehicleYear')) : null,
                    color: getValue('vehicleColor').trim(),
                    driverShiftA: getValue('vehicleDriverA'),
                    driverShiftB: getValue('vehicleDriverB'),
                    driverShiftC: getValue('vehicleDriverC'),
                    tachographExpiry: getValue('vehicleTachograph'),
                    inspectionDate: getValue('vehicleInspection')
                };

                app.addVehicle(vehicleData);
                closeAddVehicleModal();
                updateVehiclesTable();
                updateVehicleStatistics();
                updateDashboard();
                populateVehicleSelects();
                
                showToast('Sucesso', `Veículo ${vehicleData.plate} adicionado com sucesso`, 'success');
                
            } catch (error) {
                console.error('Erro ao adicionar veículo:', error);
                showToast('Erro', error.message || 'Erro ao adicionar veículo', 'error');
            }
        }

        function handleEditVehicle() {
            try {
                const vehicleId = parseInt(getValue('editVehicleId'));
                const updates = {
                    fleetNumber: getValue('editVehicleFleetNumber').trim(),
                    plate: getValue('editVehiclePlate').trim().toUpperCase(),
                    model: getValue('editVehicleModel').trim(),
                    year: getValue('editVehicleYear') ? parseInt(getValue('editVehicleYear')) : null,
                    color: getValue('editVehicleColor').trim(),
                    driverShiftA: getValue('editVehicleDriverA'),
                    driverShiftB: getValue('editVehicleDriverB'),
                    driverShiftC: getValue('editVehicleDriverC'),
                    tachographExpiry: getValue('editVehicleTachograph'),
                    inspectionDate: getValue('editVehicleInspection')
                };

                app.updateVehicle(vehicleId, updates);
                closeEditVehicleModal();
                updateVehiclesTable();
                updateVehicleStatistics();
                updateDashboard();
                populateVehicleSelects();
                
                showToast('Sucesso', `Veículo ${updates.plate} atualizado com sucesso`, 'success');
                
            } catch (error) {
                console.error('Erro ao editar veículo:', error);
                showToast('Erro', error.message || 'Erro ao editar veículo', 'error');
            }
        }

        function handleAddDriver() {
            try {
                const driverData = {
                    name: getValue('driverName').trim(),
                    license: getValue('driverLicense').trim().replace(/\D/g, ''),
                    category: getValue('driverCategory'),
                    birthDate: getValue('driverBirthDate'),
                    licenseExpiry: getValue('driverLicenseExpiry'),
                    phone: getValue('driverPhone').trim(),
                    email: getValue('driverEmail').trim()
                };

                app.addDriver(driverData);
                closeAddDriverModal();
                updateDriversTable();
                updateDriverStatistics();
                updateDashboard();
                populateDriverSelects();
                
                showToast('Sucesso', `Motorista ${driverData.name} adicionado com sucesso`, 'success');
                
            } catch (error) {
                console.error('Erro ao adicionar motorista:', error);
                showToast('Erro', error.message || 'Erro ao adicionar motorista', 'error');
            }
        }

        function handleEditDriver() {
            try {
                const driverId = parseInt(getValue('editDriverId'));
                const updates = {
                    name: getValue('editDriverName').trim(),
                    license: getValue('editDriverLicense').trim().replace(/\D/g, ''),
                    category: getValue('editDriverCategory'),
                    birthDate: getValue('editDriverBirthDate'),
                    licenseExpiry: getValue('editDriverLicenseExpiry'),
                    phone: getValue('editDriverPhone').trim(),
                    email: getValue('editDriverEmail').trim()
                };

                app.updateDriver(driverId, updates);
                closeEditDriverModal();
                updateDriversTable();
                updateDriverStatistics();
                updateDashboard();
                populateDriverSelects();
                
                showToast('Sucesso', `Motorista ${updates.name} atualizado com sucesso`, 'success');
                
            } catch (error) {
                console.error('Erro ao editar motorista:', error);
                showToast('Erro', error.message || 'Erro ao editar motorista', 'error');
            }
        }

        function handleSpeedEntry() {
            try {
                const recordData = {
                    vehicleId: parseInt(getValue('speedVehicleSelect')),
                    shift: getValue('speedShiftSelect'),
                    speed: parseInt(getValue('speedValue')),
                    speedLimit: parseInt(getValue('speedLimit')),
                    datetime: getValue('speedDateTime'),
                    location: getValue('speedLocation').trim(),
                    observations: getValue('speedObservations').trim(),
                    status: calculateSpeedStatus(parseInt(getValue('speedValue')), parseInt(getValue('speedLimit')))
                };

                app.addSpeedRecord(recordData);
                updateSpeedTracking();
                updateDashboard();
                
                // Clear form but keep vehicle and shift selected
                setElementValue('speedValue', '');
                setElementValue('speedObservations', '');
                
                // Set new current datetime
                const now = new Date();
                setElementValue('speedDateTime', now.toISOString().slice(0, 16));
                
                const speedStatus = recordData.status;
                const alertType = speedStatus.includes('Grave') ? 'error' : speedStatus.includes('Infração') ? 'warning' : 'success';
                showToast('Velocidade Registrada', `${recordData.speed}km/h registrado - Status: ${speedStatus}`, alertType);
                
            } catch (error) {
                console.error('Erro ao registrar velocidade:', error);
                showToast('Erro', error.message || 'Erro ao registrar velocidade', 'error');
            }
        }

        function handleQuickSpeedEntry() {
            try {
                const recordData = {
                    vehicleId: parseInt(getValue('quickSpeedVehicle')),
                    shift: getValue('quickSpeedShift'),
                    speed: parseInt(getValue('quickSpeedValue')),
                    speedLimit: parseInt(getValue('quickSpeedLimit')),
                    datetime: getValue('quickSpeedDateTime'),
                    location: getValue('quickSpeedLocation').trim(),
                    observations: '',
                    status: calculateSpeedStatus(parseInt(getValue('quickSpeedValue')), parseInt(getValue('quickSpeedLimit')))
                };

                app.addSpeedRecord(recordData);
                closeSpeedEntryModal();
                updateSpeedTracking();
                updateDashboard();
                
                const speedStatus = recordData.status;
                const alertType = speedStatus.includes('Grave') ? 'error' : speedStatus.includes('Infração') ? 'warning' : 'success';
                showToast('Velocidade Registrada', `${recordData.speed}km/h registrado - Status: ${speedStatus}`, alertType);
                
            } catch (error) {
                console.error('Erro ao registrar velocidade rápida:', error);
                showToast('Erro', error.message || 'Erro ao registrar velocidade', 'error');
            }
        }

        // ========================================
        // ENHANCED UTILITY AND HELPER FUNCTIONS
        // ========================================

        function calculateSpeedStatus(speed, speedLimit) {
            const overLimit = speed - speedLimit;
            const percentageOver = (overLimit / speedLimit) * 100;
            
            if (overLimit <= 0) {
                return 'Normal';
            } else if (percentageOver <= 20) {
                return 'Infração';
            } else {
                return 'Infração Grave';
            }
        }

        function calculateDriverStatus(licenseExpiry) {
            const today = new Date();
            const expiryDate = new Date(licenseExpiry);
            const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntilExpiry < 0) {
                return 'CNH Vencida';
            } else if (daysUntilExpiry <= app.settings.alertDays) {
                return 'A vencer';
            } else {
                return 'Ativo';
            }
        }

        function getStatusClass(status) {
            const statusClasses = {
                'Em dia': 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-200',
                'Ativo': 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-200',
                'Normal': 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-200',
                'A vencer': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200',
                'Vencido': 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-200',
                'CNH Vencida': 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-200',
                'Inativo': 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-200',
                'Infração': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200',
                'Infração Grave': 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-200'
            };
            return statusClasses[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-200';
        }

        function getDaysUntilExpiry(dateString) {
            const today = new Date();
            const expiryDate = new Date(dateString);
            const daysUntil = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntil < 0) {
                return `Vencido há ${Math.abs(daysUntil)}`;
            } else if (daysUntil === 0) {
                return 'Vence hoje';
            } else {
                return `${daysUntil}`;
            }
        }

        function getDriverNameById(driverId) {
            if (!driverId) return '';
            const driver = app.data.drivers.find(d => d.id === parseInt(driverId));
            return driver ? driver.name : '';
        }

        function getVehiclesAssignedToDriver(driverId) {
            return app.data.vehicles.reduce((assigned, vehicle) => {
                if (vehicle.driverShiftA && vehicle.driverShiftA == driverId) {
                    assigned.push({ vehicle: `${vehicle.plate} (${vehicle.fleetNumber || 'N/A'})`, shift: 'A' });
                }
                if (vehicle.driverShiftB && vehicle.driverShiftB == driverId) {
                    assigned.push({ vehicle: `${vehicle.plate} (${vehicle.fleetNumber || 'N/A'})`, shift: 'B' });
                }
                if (vehicle.driverShiftC && vehicle.driverShiftC == driverId) {
                    assigned.push({ vehicle: `${vehicle.plate} (${vehicle.fleetNumber || 'N/A'})`, shift: 'C' });
                }
                return assigned;
            }, []);
        }

        function updateDriverOptions() {
            updateDriverInfo();
        }

        function updateQuickDriverOptions() {
            updateQuickDriverInfo();
        }

        function updateDriverInfo() {
            const vehicleId = getValue('speedVehicleSelect');
            const shift = getValue('speedShiftSelect');
            updateDriverInfoForElements(vehicleId, shift, 'speedDriverInfo');
        }

        function updateQuickDriverInfo() {
            const vehicleId = getValue('quickSpeedVehicle');
            const shift = getValue('quickSpeedShift');
            updateDriverInfoForElements(vehicleId, shift, 'quickSpeedDriverInfo');
        }

        function updateDriverInfoForElements(vehicleId, shift, targetElementId) {
            const element = document.getElementById(targetElementId);
            if (!element || !vehicleId || !shift) {
                if (element) element.value = '';
                return;
            }
            
            const vehicle = app.data.vehicles.find(v => v.id === parseInt(vehicleId));
            if (!vehicle) {
                element.value = '';
                return;
            }
            
            const driverName = app.getDriverNameByShift(vehicle, shift);
            element.value = driverName;
        }

        function clearDriverInfo() {
            setElementValue('speedDriverInfo', '');
            setElementValue('quickSpeedDriverInfo', '');
        }

        function updateSpeedIndicator() {
            const speed = getValue('speedValue') || getValue('quickSpeedValue');
            const limit = getValue('speedLimit') || getValue('quickSpeedLimit');
            
            const indicators = ['speedIndicator', 'speedIndicatorMain'];
            const previews = ['speedStatusPreview'];
            
            indicators.forEach(indicatorId => {
                const indicator = document.getElementById(indicatorId);
                if (indicator && speed && limit) {
                    const overLimit = parseInt(speed) - parseInt(limit);
                    
                    if (overLimit <= 0) {
                        indicator.className = 'absolute right-3 top-3 w-3 h-3 rounded-full bg-green-500 transition-all duration-300';
                    } else if (overLimit <= parseInt(limit) * 0.2) {
                        indicator.className = 'absolute right-3 top-3 w-3 h-3 rounded-full bg-yellow-500 transition-all duration-300';
                    } else {
                        indicator.className = 'absolute right-3 top-3 w-3 h-3 rounded-full bg-red-500 animate-pulse transition-all duration-300';
                    }
                }
            });
            
            // Update speed preview
            if (speed && limit) {
                const status = calculateSpeedStatus(parseInt(speed), parseInt(limit));
                const statusText = document.getElementById('speedStatusText');
                const previewBar = document.getElementById('speedPreviewBar');
                const preview = document.getElementById('speedStatusPreview');
                
                if (statusText) {
                    statusText.textContent = status;
                    statusText.className = `text-sm font-medium ${getStatusClass(status).includes('green') ? 'text-green-600' : getStatusClass(status).includes('yellow') ? 'text-yellow-600' : 'text-red-600'}`;
                }
                
                if (previewBar) {
                    const percentage = Math.min((parseInt(speed) / parseInt(limit)) * 100, 150);
                    previewBar.style.width = `${percentage}%`;
                    
                    if (status === 'Normal') {
                        previewBar.className = 'h-2 rounded-full transition-all duration-500 bg-green-500';
                    } else if (status === 'Infração') {
                        previewBar.className = 'h-2 rounded-full transition-all duration-500 bg-yellow-500';
                    } else {
                        previewBar.className = 'h-2 rounded-full transition-all duration-500 bg-red-500';
                    }
                }
                
                if (preview) {
                    preview.classList.remove('hidden');
                }
            }
        }

        // ========================================
        // ENHANCED SELECT POPULATION FUNCTIONS
        // ========================================

        function populateSelects() {
            populateDriverSelects();
            populateVehicleSelects();
            populateReportSelects();
        }

        function populateDriverSelects() {
            const selects = [
                'vehicleDriverA', 'vehicleDriverB', 'vehicleDriverC',
                'editVehicleDriverA', 'editVehicleDriverB', 'editVehicleDriverC'
            ];
            
            selects.forEach(selectId => {
                populateSelectOptions(selectId, app.data.drivers, 'id', 'name');
            });
        }

        function populateVehicleSelects() {
            const selects = ['speedVehicleSelect', 'quickSpeedVehicle'];
            
            selects.forEach(selectId => {
                populateSelectOptionsVehicles(selectId);
            });
            
            populateSpeedHistoryFilters();
        }

        function populateSpeedHistoryFilters() {
            populateSelectOptionsVehicles('speedHistoryVehicle');
        }

        function populateReportSelects() {
            populateSelectOptionsVehicles('reportVehicle');
        }

        function populateSelectOptions(selectId, data, valueField, textField) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Save current value
            const currentValue = select.value;
            
            // Clear existing options except the first one (placeholder)
            const firstOption = select.firstElementChild;
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            // Add options
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = item[textField];
                select.appendChild(option);
            });
            
            // Restore value if it still exists
            if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }
        }

        function populateSelectOptionsVehicles(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Save current value
            const currentValue = select.value;
            
            // Clear existing options except the first one (placeholder)
            const firstOption = select.firstElementChild;
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            // Add vehicle options
            app.data.vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.plate} ${vehicle.fleetNumber ? `(Frota ${vehicle.fleetNumber})` : ''} - ${vehicle.model}`;
                select.appendChild(option);
            });
            
            // Restore value if it still exists
            if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }
        }

        function populateYearFilters() {
            const yearSelect = document.getElementById('vehicleYearFilter');
            if (!yearSelect) return;
            
            const years = [...new Set(app.data.vehicles.map(v => v.year).filter(y => y))].sort((a, b) => b - a);
            
            // Clear existing options except the first one
            const firstOption = yearSelect.firstElementChild;
            yearSelect.innerHTML = '';
            if (firstOption) {
                yearSelect.appendChild(firstOption);
            }
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        // ========================================
        // ENHANCED VALIDATION FUNCTIONS
        // ========================================

        function validatePlate(input) {
            const plate = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            const validation = document.getElementById(input.id === 'vehiclePlate' ? 'plateValidation' : 'editPlateValidation');
            
            if (!validation) return;
            
            // Format plate as user types
            if (plate.length <= 7) {
                if (plate.length <= 3) {
                    input.value = plate;
                } else if (plate.length <= 7) {
                    // Check if it's new format (Mercosul) or old format
                    if (plate.length === 7 && isNaN(plate[4])) {
                        // New format: ABC1D23
                        input.value = plate;
                    } else {
                        // Old format: ABC-1234
                        input.value = plate.substring(0, 3) + '-' + plate.substring(3);
                    }
                }
            }
            
            // Validate format
            const plateValue = input.value;
            const oldFormat = /^[A-Z]{3}-\d{4}$/;
            const newFormat = /^[A-Z]{3}\d[A-Z]\d{3}$/;
            
            if (plateValue.length === 0) {
                validation.classList.add('hidden');
            } else if (oldFormat.test(plateValue) || newFormat.test(plateValue)) {
                validation.textContent = '✓ Formato válido';
                validation.className = 'text-xs mt-1 text-green-600';
            } else {
                validation.textContent = '✗ Formato inválido (ABC-1234 ou ABC1D23)';
                validation.className = 'text-xs mt-1 text-red-600';
            }
        }

        function validateCNH(input) {
            const cnh = input.value.replace(/\D/g, '');
            const validation = document.getElementById(input.id === 'driverLicense' ? 'cnhValidation' : 'editCnhValidation');
            
            if (!validation) return;
            
            // Format CNH as user types
            if (cnh.length <= 11) {
                input.value = cnh;
            }
            
            if (cnh.length === 0) {
                validation.classList.add('hidden');
            } else if (cnh.length === 11) {
                validation.textContent = '✓ CNH válida';
                validation.className = 'text-xs mt-1 text-green-600';
            } else {
                validation.textContent = '✗ CNH deve ter 11 dígitos';
                validation.className = 'text-xs mt-1 text-red-600';
            }
        }

        function formatPhone(input) {
            let phone = input.value.replace(/\D/g, '');
            
            if (phone.length <= 11) {
                if (phone.length <= 2) {
                    input.value = phone;
                } else if (phone.length <= 6) {
                    input.value = `(${phone.substring(0, 2)}) ${phone.substring(2)}`;
                } else if (phone.length <= 10) {
                    input.value = `(${phone.substring(0, 2)}) ${phone.substring(2, 6)}-${phone.substring(6)}`;
                } else {
                    input.value = `(${phone.substring(0, 2)}) ${phone.substring(2, 7)}-${phone.substring(7)}`;
                }
            }
        }

        // ========================================
        // ENHANCED CHART FUNCTIONS
        // ========================================

        function initCharts() {
            initDocumentsChart();
            initViolationsChart();
        }

        function initDocumentsChart() {
            const ctx = document.getElementById('documentsChart');
            if (!ctx) return;
            
            const { expiringSoon, expired } = app.calculateExpirations();
            const totalDocuments = (app.data.vehicles.length * 2) + app.data.drivers.length;
            const upToDate = totalDocuments - expiringSoon - expired;
            
            app.charts.documents = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Em dia', 'A vencer', 'Vencidos'],
                    datasets: [{
                        data: [upToDate, expiringSoon, expired],
                        backgroundColor: [
                            '#10B981',
                            '#F59E0B',
                            '#EF4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((sum, value) => sum + value, 0);
                                    const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        duration: 1000
                    }
                }
            });
        }

        function initViolationsChart() {
            const ctx = document.getElementById('violationsChart');
            if (!ctx) return;
            
            const period = parseInt(getValue('violationsChartPeriod') || '7');
            const violationsData = getViolationsDataForPeriod(period);
            
            app.charts.violations = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: violationsData.labels,
                    datasets: [{
                        label: 'Infrações',
                        data: violationsData.violations,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Infrações Graves',
                        data: violationsData.serious,
                        borderColor: '#EF4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function getViolationsDataForPeriod(days) {
            const labels = [];
            const violations = [];
            const serious = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
                
                const dayViolations = app.data.speedRecords.filter(r => 
                    r.datetime.startsWith(dateString) && r.status === 'Infração'
                ).length;
                
                const daySerious = app.data.speedRecords.filter(r => 
                    r.datetime.startsWith(dateString) && r.status === 'Infração Grave'
                ).length;
                
                violations.push(dayViolations);
                serious.push(daySerious);
            }
            
            return { labels, violations, serious };
        }

        function refreshDocumentsChart() {
            if (app.charts.documents) {
                const { expiringSoon, expired } = app.calculateExpirations();
                const totalDocuments = (app.data.vehicles.length * 2) + app.data.drivers.length;
                const upToDate = totalDocuments - expiringSoon - expired;
                
                app.charts.documents.data.datasets[0].data = [upToDate, expiringSoon, expired];
                app.charts.documents.update();
            }
        }

        function refreshViolationsChart() {
            if (app.charts.violations) {
                const period = parseInt(getValue('violationsChartPeriod') || '7');
                const violationsData = getViolationsDataForPeriod(period);
                
                app.charts.violations.data.labels = violationsData.labels;
                app.charts.violations.data.datasets[0].data = violationsData.violations;
                app.charts.violations.data.datasets[1].data = violationsData.serious;
                app.charts.violations.update();
            }
        }

        function toggleChartType(chartName) {
            if (chartName === 'documents' && app.charts.documents) {
                const currentType = app.charts.documents.config.type;
                const newType = currentType === 'doughnut' ? 'bar' : 'doughnut';
                
                app.charts.documents.destroy();
                
                const ctx = document.getElementById('documentsChart');
                const { expiringSoon, expired } = app.calculateExpirations();
                const totalDocuments = (app.data.vehicles.length * 2) + app.data.drivers.length;
                const upToDate = totalDocuments - expiringSoon - expired;
                
                app.charts.documents = new Chart(ctx, {
                    type: newType,
                    data: {
                        labels: ['Em dia', 'A vencer', 'Vencidos'],
                        datasets: [{
                            data: [upToDate, expiringSoon, expired],
                            backgroundColor: [
                                '#10B981',
                                '#F59E0B',
                                '#EF4444'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: newType === 'doughnut' ? 'bottom' : 'top',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: newType === 'bar' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        } : {}
                    }
                });
            }
        }

        // ========================================
        // ENHANCED NOTIFICATION FUNCTIONS
        // ========================================

        function showNotificationsPanel() {
            const panel = document.getElementById('notificationsPanel');
            if (panel.classList.contains('hidden')) {
                updateNotificationsList();
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }

        function updateNotificationsList() {
            const list = document.getElementById('notificationsList');
            if (!list) return;
            
            const notifications = app.data.notifications;
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-bell-slash text-gray-300 dark:text-gray-600 text-4xl mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400 font-medium">Nenhuma notificação</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Você está em dia!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = notifications.map(notification => {
                const typeIcon = {
                    success: 'fa-check-circle text-green-500',
                    warning: 'fa-exclamation-triangle text-yellow-500',
                    error: 'fa-times-circle text-red-500',
                    info: 'fa-info-circle text-blue-500'
                }[notification.type] || 'fa-bell text-gray-500';
                
                return `
                    <div class="flex items-start p-3 rounded-lg ${notification.read ? 'opacity-60' : 'bg-gray-50 dark:bg-gray-700'} hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200">
                        <i class="fas ${typeIcon} mr-3 mt-1"></i>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-white">${notification.title}</h4>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${notification.message}</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">
                                ${new Date(notification.datetime).toLocaleString('pt-BR')}
                            </p>
                        </div>
                        ${!notification.read ? '<div class="w-2 h-2 bg-primary rounded-full ml-2 mt-2"></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function markAllAsRead() {
            app.markAllNotificationsAsRead();
            updateNotificationsList();
            showToast('Sucesso', 'Todas as notificações foram marcadas como lidas', 'success');
        }

        function clearAllNotifications() {
            showConfirmDialog('Tem certeza que deseja limpar todas as notificações?', () => {
                app.clearAllNotifications();
                updateNotificationsList();
                showToast('Limpo', 'Todas as notificações foram removidas', 'info');
            });
        }

        // ========================================
        // ENHANCED TOAST FUNCTIONS
        // ========================================

        function showToast(title, message, type = 'info', duration = 5000) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastProgress = document.getElementById('toastProgress');
            
            if (!toast) return;
            
            // Set content
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Set icon and colors based on type
            const config = {
                success: { icon: 'fa-check-circle', color: 'text-green-500', border: 'border-green-500', progress: 'bg-green-500' },
                error: { icon: 'fa-times-circle', color: 'text-red-500', border: 'border-red-500', progress: 'bg-red-500' },
                warning: { icon: 'fa-exclamation-triangle', color: 'text-yellow-500', border: 'border-yellow-500', progress: 'bg-yellow-500' },
                info: { icon: 'fa-info-circle', color: 'text-blue-500', border: 'border-blue-500', progress: 'bg-blue-500' }
            }[type] || config.info;
            
            toastIcon.className = `fas ${config.icon} ${config.color} text-xl mr-3`;
            toast.querySelector('div').className = `bg-white dark:bg-gray-800 ${config.border} rounded-lg shadow-xl p-4 max-w-sm transform transition-all duration-300 animate-slide-up`;
            toastProgress.className = `absolute bottom-0 left-0 h-1 ${config.progress} rounded-b-lg transition-all duration-${duration}`;
            
            // Show toast
            toast.classList.remove('hidden');
            
            // Animate progress bar
            setTimeout(() => {
                toastProgress.style.width = '0%';
            }, 100);
            
            // Auto hide
            setTimeout(() => {
                hideToast();
            }, duration);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            const toastProgress = document.getElementById('toastProgress');
            
            if (toast) {
                toast.classList.add('hidden');
                toastProgress.style.width = '100%';
            }
        }

        // ========================================
        // ENHANCED CONFIRMATION DIALOG
        // ========================================

        function showConfirmDialog(message, onConfirm, details = '', showDetails = true) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-lg w-full max-h-screen overflow-y-auto transform transition-all duration-300 scale-95 opacity-0">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0 w-10 h-10 bg-yellow-100 dark:bg-yellow-900/20 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-question-circle text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Confirmação</h3>
                    </div>
                    <div class="mb-6">
                        <p class="text-gray-700 dark:text-gray-300">${message}</p>
                        ${details && showDetails ? `<div class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm">${details}</div>` : ''}
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button class="px-6 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all duration-200" onclick="this.closest('.fixed').remove()">
                            ${showDetails ? 'Fechar' : 'Cancelar'}
                        </button>
                        ${showDetails ? '' : `
                            <button class="px-6 py-2 bg-gradient-to-r from-primary to-primary/80 text-white hover:from-primary/90 hover:to-primary/70 rounded-lg transition-all duration-200 font-medium" onclick="this.closest('.fixed').remove(); (${onConfirm})()">
                                Confirmar
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animate in
            setTimeout(() => {
                const content = modal.querySelector('div > div');
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // Close on outside click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showAlert(message, type = 'warning') {
            const config = {
                success: { icon: 'fa-check-circle', color: 'text-green-600', bg: 'bg-green-100 dark:bg-green-900/20' },
                error: { icon: 'fa-times-circle', color: 'text-red-600', bg: 'bg-red-100 dark:bg-red-900/20' },
                warning: { icon: 'fa-exclamation-triangle', color: 'text-yellow-600', bg: 'bg-yellow-100 dark:bg-yellow-900/20' },
                info: { icon: 'fa-info-circle', color: 'text-blue-600', bg: 'bg-blue-100 dark:bg-blue-900/20' }
            }[type] || config.warning;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full transform transition-all duration-300 scale-95 opacity-0">
                    <div class="flex items-center mb-4">
                        <div class="flex-shrink-0 w-10 h-10 ${config.bg} rounded-full flex items-center justify-center mr-4">
                            <i class="fas ${config.icon} ${config.color}"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-6 py-2 bg-gradient-to-r from-primary to-primary/80 text-white hover:from-primary/90 hover:to-primary/70 rounded-lg transition-all duration-200 font-medium" onclick="this.closest('.fixed').remove()">
                            OK
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animate in
            setTimeout(() => {
                const content = modal.querySelector('div > div');
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // ========================================
        // ENHANCED DATA MANAGEMENT FUNCTIONS
        // ========================================

        function updateAllTables() {
            updateVehiclesTable();
            updateDriversTable();
            updateSpeedHistoryTable();
        }

        function updateDataStatistics() {
            const stats = app.getStats();
            
            setElementText('statsVehicles', stats.totalVehicles);
            setElementText('statsDrivers', stats.totalDrivers);
            setElementText('statsSpeed', stats.totalSpeedRecords);
            setElementText('statsActivities', stats.totalActivities);
            
            // Calculate data sizes
            const dataSize = new Blob([JSON.stringify(app.data)]).size;
            const dataSizeKB = Math.round(dataSize / 1024);
            setElementText('dataSize', `${dataSizeKB} KB`);
            
            // Calculate record count
            const totalRecords = stats.totalVehicles + stats.totalDrivers + stats.totalSpeedRecords;
            setElementText('totalRecords', totalRecords);
            
            setElementText('lastUpdate', new Date().toLocaleString('pt-BR'));
        }

        function forceSave() {
            showLoadingOverlay();
            
            setTimeout(() => {
                const success = app.saveData();
                hideLoadingOverlay();
                
                if (success) {
                    showToast('Sucesso', 'Dados salvos com sucesso', 'success');
                    updateDataStatistics();
                } else {
                    showToast('Erro', 'Falha ao salvar dados', 'error');
                }
            }, 500);
        }

        function downloadAllData() {
            app.exportData('all', 'json', 'all');
            showToast('Download Iniciado', 'Backup completo está sendo baixado', 'info');
        }

        function validateData() {
            showLoadingOverlay();
            
            setTimeout(() => {
                let issues = [];
                
                // Validate vehicles
                app.data.vehicles.forEach((vehicle, index) => {
                    if (!vehicle.plate) issues.push(`Veículo ${index + 1}: Placa não informada`);
                    if (!vehicle.model) issues.push(`Veículo ${index + 1}: Modelo não informado`);
                    if (!vehicle.tachographExpiry) issues.push(`Veículo ${index + 1}: Data tacógrafo não informada`);
                });
                
                // Validate drivers
                app.data.drivers.forEach((driver, index) => {
                    if (!driver.name) issues.push(`Motorista ${index + 1}: Nome não informado`);
                    if (!driver.license) issues.push(`Motorista ${index + 1}: CNH não informada`);
                    if (!driver.licenseExpiry) issues.push(`Motorista ${index + 1}: Vencimento CNH não informado`);
                });
                
                hideLoadingOverlay();
                
                if (issues.length === 0) {
                    showToast('Validação OK', 'Todos os dados estão válidos', 'success');
                } else {
                    showAlert(`Encontrados ${issues.length} problemas:\n\n${issues.slice(0, 5).join('\n')}${issues.length > 5 ? '\n...' : ''}`, 'warning');
                }
            }, 1000);
        }

        function clearAllData() {
            showConfirmDialog('ATENÇÃO: Esta ação irá remover TODOS os dados do sistema. Esta ação não pode ser desfeita!', () => {
                showConfirmDialog('Tem certeza absoluta? Digite "CONFIRMAR" para continuar:', () => {
                    app.data = { ...app.defaultData };
                    app.saveData();
                    updateAllTables();
                    updateDashboard();
                    updateDataStatistics();
                    
                    showToast('Dados Limpos', 'Todos os dados foram removidos', 'warning');
                });
            });
        }

        function exportAllData() {
            const menu = document.createElement('div');
            menu.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            menu.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl max-w-md w-full">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Exportar Dados</h3>
                    <div class="space-y-3">
                        <button onclick="app.exportData('all', 'json'); this.closest('.fixed').remove()" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-file-code text-blue-500 mr-3"></i>JSON (Backup Completo)
                        </button>
                        <button onclick="app.exportData('all', 'xlsx'); this.closest('.fixed').remove()" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-file-excel text-green-500 mr-3"></i>Excel (Planilhas)
                        </button>
                        <button onclick="app.exportData('all', 'csv'); this.closest('.fixed').remove()" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-file-csv text-orange-500 mr-3"></i>CSV (Tabelas)
                        </button>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(menu);
        }

        function exportToExcel() {
            app.exportData('all', 'xlsx', '30');
            showToast('Excel Exportado', 'Dados exportados para Excel com sucesso', 'success');
        }

        function importSampleData() {
            showConfirmDialog('Deseja carregar dados de exemplo? Isso irá adicionar veículos e motoristas de demonstração.', () => {
                const sampleData = generateSampleData();
                const importCount = app.importData(sampleData, false);
                
                updateAllTables();
                updateDashboard();
                populateSelects();
                updateDataStatistics();
                
                showToast('Dados de Exemplo', `${importCount} registros de exemplo foram adicionados`, 'success');
            });
        }

        function generateSampleData() {
            return {
                vehicles: [
                    {
                        fleetNumber: 'FR-001',
                        plate: 'ABC-1234',
                        model: 'Volvo FH 540',
                        year: 2020,
                        color: 'Branco',
                        tachographExpiry: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        inspectionDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    },
                    {
                        fleetNumber: 'FR-002',
                        plate: 'DEF-5678',
                        model: 'Scania R 450',
                        year: 2019,
                        color: 'Azul',
                        tachographExpiry: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        inspectionDate: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    }
                ],
                drivers: [
                    {
                        name: 'João Silva',
                        license: '12345678901',
                        category: 'E',
                        licenseExpiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        phone: '(11) 99999-9999',
                        email: 'joao.silva@email.com'
                    },
                    {
                        name: 'Maria Santos',
                        license: '10987654321',
                        category: 'D',
                        licenseExpiry: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        phone: '(11) 88888-8888',
                        email: 'maria.santos@email.com'
                    }
                ]
            };
        }

        // ========================================
        // ENHANCED SETTINGS FUNCTIONS
        // ========================================

        function loadSettingsToModal() {
            setElementValue('autoSaveEnabled', app.settings.autoSave);
            setElementValue('notificationsEnabled', app.settings.notificationsEnabled);
            setElementValue('soundNotifications', app.settings.soundNotifications);
            setElementValue('emailAlerts', app.settings.emailAlerts);
            setElementValue('speedAlerts', app.settings.speedAlerts);
            setElementValue('itemsPerPage', app.settings.itemsPerPage);
            setElementValue('alertDays', app.settings.alertDays);
            setElementValue('themeSelector', app.settings.theme);
        }

        function saveSettings() {
            app.settings.autoSave = getValue('autoSaveEnabled');
            app.settings.notificationsEnabled = getValue('notificationsEnabled');
            app.settings.soundNotifications = getValue('soundNotifications');
            app.settings.emailAlerts = getValue('emailAlerts');
            app.settings.speedAlerts = getValue('speedAlerts');
            app.settings.itemsPerPage = parseInt(getValue('itemsPerPage'));
            app.settings.alertDays = parseInt(getValue('alertDays'));
            app.settings.theme = getValue('themeSelector');
            
            // Update pagination settings
            app.pagination.vehicles.itemsPerPage = app.settings.itemsPerPage;
            app.pagination.drivers.itemsPerPage = app.settings.itemsPerPage;
            app.pagination.speedRecords.itemsPerPage = app.settings.itemsPerPage;
            
            app.saveSettings();
            applyThemeSettings();
            updateAllTables();
            
            closeSettingsModal();
            showToast('Configurações Salvas', 'Suas configurações foram aplicadas', 'success');
        }

        function resetSettings() {
            showConfirmDialog('Deseja restaurar todas as configurações para os valores padrão?', () => {
                app.settings = { ...app.defaultSettings };
                loadSettingsToModal();
                showToast('Configurações Restauradas', 'Configurações restauradas para o padrão', 'info');
            });
        }

        function applyThemeSettings() {
            const theme = app.settings.theme;
            
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                // Auto theme - use system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
        }

        // ========================================
        // ENHANCED REPORT FUNCTIONS
        // ========================================

        function generateQuickReport() {
            const reportData = app.generateReportData('7', 'general');
            const reportHtml = generateReportHTML(reportData, 'Relatório Rápido - Últimos 7 dias');
            
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHtml);
            reportWindow.document.close();
            
            showToast('Relatório Gerado', 'Relatório rápido foi aberto em nova janela', 'success');
        }

        function generateReport() {
            const period = getValue('reportPeriod');
            const type = getValue('reportType');
            const vehicleId = getValue('reportVehicle');
            const format = getValue('reportFormat');
            
            if (format === 'html') {
                const reportData = app.generateReportData(period, type, vehicleId);
                const reportHtml = generateReportHTML(reportData, `Relatório ${type} - Período: ${period} dias`);
                
                document.getElementById('reportContent').innerHTML = reportHtml;
                showToast('Relatório Gerado', 'Relatório foi gerado com sucesso', 'success');
            } else {
                app.exportData('reports', format, period);
                showToast('Relatório Exportado', `Relatório foi exportado em formato ${format.toUpperCase()}`, 'success');
            }
        }

        function generateReportHTML(data, title) {
            return `
                <div class="space-y-6">
                    <div class="text-center border-b border-gray-200 dark:border-gray-700 pb-4">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">${title}</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Gerado em ${new Date().toLocaleString('pt-BR')}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${data.summary.totalVehicles}</div>
                            <div class="text-sm text-blue-800 dark:text-blue-200">Total de Veículos</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600 dark:text-green-400">${data.summary.totalDrivers}</div>
                            <div class="text-sm text-green-800 dark:text-green-200">Total de Motoristas</div>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">${data.summary.expiringSoon}</div>
                            <div class="text-sm text-yellow-800 dark:text-yellow-200">A Vencer</div>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600 dark:text-red-400">${data.summary.expired}</div>
                            <div class="text-sm text-red-800 dark:text-red-200">Vencidos</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Status da Frota</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Veículos OK:</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${data.fleetStatus.vehiclesOk}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Motoristas Ativos:</span>
                                    <span class="font-medium text-gray-900 dark:text-white">${data.fleetStatus.activeDrivers}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Taxa de Conformidade:</span>
                                    <span class="font-medium text-green-600 dark:text-green-400">${data.fleetStatus.complianceRate}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Infrações de Velocidade</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Normal:</span>
                                    <span class="font-medium text-green-600 dark:text-green-400">${data.speedStats.normal}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Infrações:</span>
                                    <span class="font-medium text-yellow-600 dark:text-yellow-400">${data.speedStats.violations}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Infrações Graves:</span>
                                    <span class="font-medium text-red-600 dark:text-red-400">${data.speedStats.serious}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${data.urgentAlerts.length > 0 ? `
                        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-3 text-red-800 dark:text-red-200">Alertas Urgentes</h3>
                            <div class="space-y-2">
                                ${data.urgentAlerts.map(alert => `
                                    <div class="flex items-center text-sm text-red-700 dark:text-red-300">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        ${alert.message}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function exportReport() {
            app.exportData('reports', 'xlsx', getValue('reportPeriod'));
            showToast('Relatório Exportado', 'Relatório foi exportado para Excel', 'success');
        }

        function printReport() {
            const content = document.getElementById('reportContent');
            if (content.innerHTML.trim() === '' || content.innerHTML.includes('Selecione os filtros')) {
                showAlert('Gere um relatório primeiro antes de imprimir', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>FleetControl Pro - Relatório</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .grid { display: grid; gap: 20px; }
                        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
                        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
                        .bg-blue-50, .bg-green-50, .bg-yellow-50, .bg-red-50 { 
                            padding: 15px; border-radius: 8px; text-align: center; 
                        }
                        .bg-blue-50 { background: #EBF8FF; }
                        .bg-green-50 { background: #F0FDF4; }
                        .bg-yellow-50 { background: #FFFBEB; }
                        .bg-red-50 { background: #FEF2F2; }
                        .text-2xl { font-size: 1.5rem; font-weight: bold; }
                        .text-lg { font-size: 1.125rem; font-weight: 600; }
                        .border-b { border-bottom: 1px solid #E5E7EB; }
                        .pb-4 { padding-bottom: 1rem; }
                        .mb-3 { margin-bottom: 0.75rem; }
                        .space-y-2 > * + * { margin-top: 0.5rem; }
                        .flex { display: flex; }
                        .justify-between { justify-content: space-between; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${content.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function shareReport() {
            const content = document.getElementById('reportContent');
            if (content.innerHTML.trim() === '' || content.innerHTML.includes('Selecione os filtros')) {
                showAlert('Gere um relatório primeiro antes de compartilhar', 'warning');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: 'FleetControl Pro - Relatório',
                    text: 'Relatório gerado pelo FleetControl Pro',
                    url: window.location.href
                }).catch(console.error);
            } else {
                // Fallback para navegadores que não suportam Web Share API
                navigator.clipboard.writeText(window.location.href).then(() => {
                    showToast('Link Copiado', 'Link do relatório copiado para a área de transferência', 'success');
                }).catch(() => {
                    showAlert('Recurso de compartilhamento não disponível neste navegador', 'info');
                });
            }
        }

        function refreshReport() {
            generateReport();
        }

        function scheduleReport() {
            showAlert('Funcionalidade de agendamento será implementada em versões futuras', 'info');
        }

        function toggleCustomDateRange() {
            const period = getValue('reportPeriod');
            const customRange = document.getElementById('customDateRange');
            
            if (period === 'custom') {
                customRange.classList.remove('hidden');
            } else {
                customRange.classList.add('hidden');
            }
        }

        // ========================================
        // ENHANCED IMPORT FUNCTIONS
        // ========================================

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const progress = document.getElementById('uploadProgress');
            
            if (preview && fileName) {
                fileName.textContent = file.name;
                preview.classList.remove('hidden');
                
                // Simulate upload progress
                let progressValue = 0;
                const interval = setInterval(() => {
                    progressValue += 10;
                    if (progress) progress.style.width = `${progressValue}%`;
                    
                    if (progressValue >= 100) {
                        clearInterval(interval);
                    }
                }, 50);
            }
        }

        function clearFileSelection() {
            const input = document.getElementById('importFileInput');
            const preview = document.getElementById('filePreview');
            const progress = document.getElementById('uploadProgress');
            
            if (input) input.value = '';
            if (preview) preview.classList.add('hidden');
            if (progress) progress.style.width = '0%';
        }

        function processImport() {
            const fileInput = document.getElementById('modalImportFile');
            const importType = getValue('importType');
            const overwrite = getValue('importOverwrite');
            
            if (!fileInput.files[0]) {
                showAlert('Selecione um arquivo para importar', 'warning');
                return;
            }
            
            showLoadingOverlay();
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let data;
                    
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        // Simplified CSV parsing - in production, use a proper CSV parser
                        showAlert('Importação CSV será implementada em versões futuras', 'info');
                        hideLoadingOverlay();
                        return;
                    } else {
                        showAlert('Formato de arquivo não suportado', 'error');
                        hideLoadingOverlay();
                        return;
                    }
                    
                    const importCount = app.importData(data, overwrite);
                    
                    updateAllTables();
                    updateDashboard();
                    populateSelects();
                    updateDataStatistics();
                    
                    hideLoadingOverlay();
                    closeImportModal();
                    
                    showToast('Importação Concluída', `${importCount} registros foram importados`, 'success');
                    
                } catch (error) {
                    console.error('Erro na importação:', error);
                    hideLoadingOverlay();
                    showAlert('Erro ao processar arquivo: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function processImportFromFile() {
            const fileInput = document.getElementById('importFileInput');
            
            if (!fileInput.files[0]) {
                showAlert('Selecione um arquivo para importar', 'warning');
                return;
            }
            
            showLoadingOverlay();
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const importCount = app.importData(data, false);
                    
                    updateAllTables();
                    updateDashboard();
                    populateSelects();
                    updateDataStatistics();
                    
                    hideLoadingOverlay();
                    clearFileSelection();
                    
                    showToast('Importação Concluída', `${importCount} registros foram importados`, 'success');
                    
                } catch (error) {
                    console.error('Erro na importação:', error);
                    hideLoadingOverlay();
                    showAlert('Erro ao processar arquivo: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function showImportGuide() {
            const guide = `
                <div class="space-y-4 text-sm">
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Formato JSON (Recomendado)</h4>
                        <p class="text-gray-600 dark:text-gray-400">Use o formato de backup do sistema. Exporte os dados primeiro para ver a estrutura.</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Estrutura de Veículos</h4>
                        <pre class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-xs overflow-x-auto">
{
  "vehicles": [
    {
      "fleetNumber": "FR-001",
      "plate": "ABC-1234",
      "model": "Volvo FH 540",
      "year": 2020,
      "color": "Branco",
      "driverShiftA": "1",
      "driverShiftB": "2",
      "driverShiftC": "",
      "tachographExpiry": "2025-12-31",
      "inspectionDate": "2024-01-15"
    }
  ]
}</pre>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Estrutura de Motoristas</h4>
                        <pre class="bg-gray-100 dark:bg-gray-700 p-2 rounded text-xs overflow-x-auto">
{
  "drivers": [
    {
      "name": "João Silva",
      "license": "12345678901",
      "category": "E",
      "licenseExpiry": "2025-06-15",
      "phone": "(11) 99999-9999",
      "email": "joao@email.com"
    }
  ]
}</pre>
                    </div>
                    
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded p-3">
                        <p class="text-yellow-800 dark:text-yellow-200 text-xs">
                            <strong>Dica:</strong> Para importar planilhas Excel, primeiro exporte os dados para ver o formato, edite no Excel e salve como JSON.
                        </p>
                    </div>
                </div>
            `;
            
            showConfirmDialog('Guia de Importação', () => {}, guide, false);
        }

        function refreshDataStats() {
            updateDataStatistics();
            showToast('Atualizado', 'Estatísticas de dados atualizadas', 'success');
        }

        function analyzeDataTrends() {
            showAlert('Análise de tendências será implementada em versões futuras', 'info');
        }

        function scheduleBackup() {
            showAlert('Agendamento de backup será implementado em versões futuras', 'info');
        }

        function exportSelectedData() {
            const type = getValue('exportType');
            const format = getValue('exportFormat');
            const period = getValue('exportPeriod');
            
            app.exportData(type, format, period);
            showToast('Exportação Iniciada', `Dados ${type} sendo exportados em formato ${format.toUpperCase()}`, 'success');
        }

        // ========================================
        // ENHANCED UTILITY FUNCTIONS
        // ========================================

        function getValue(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return '';
            
            if (element.type === 'checkbox') {
                return element.checked;
            }
            return element.value;
        }

        function setElementValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (element.type === 'checkbox') {
                element.checked = value;
            } else {
                element.value = value;
            }
        }

        function setElementText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        console.log('FleetControl Pro v3.0 carregado com sucesso! 🚛✨');
    </script>
</body>
</html>
